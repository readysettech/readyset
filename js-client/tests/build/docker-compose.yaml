version: "2.2"

services:
  zookeeper:
    image: zookeeper
    expose:
      - 2181
    healthcheck:
      test: ["CMD", "nc", "-vz", "localhost", "2181"]
      interval: 10s
      timeout: 2s
      retries: 5
      start_period: 5s
  mysql:
    image: mysql:8.0
    expose:
      - 3306
    environment:
      MYSQL_DATABASE: test
      MYSQL_ROOT_PASSWORD: root
    # doesn't actually depend on zookeeper, but I can't figure out a way to have
    # a depends_on with multiple health check relationships, so chaining them to ensure
    # noria-server waits on both zookeeper and mysql for fallback.
    depends_on:
      zookeeper:
        condition: service_healthy
    healthcheck:
      test: "mysqladmin ping"
      start_period: 10s
      interval: 10s
      timeout: 2s
      retries: 5
  noria-server:
    image: 069491470376.dkr.ecr.us-east-2.amazonaws.com/noria-server:latest
    build:
      context: ../../..
      dockerfile: build/Dockerfile.noria-server
      cache_from:
        - 069491470376.dkr.ecr.us-east-2.amazonaws.com/noria-server:latest
    expose:
      # ‚ùØ cat /proc/sys/net/ipv4/ip_local_port_range
      #   32768	60999
      - "32768-60999"
    environment:
      ZOOKEEPER_HOST: zookeeper
      LISTEN_ADDRESS: 0.0.0.0
      EXTERNAL_ADDRESS: noria-server
      DEPLOYMENT: jstests
      REPLICATION_URL: mysql://root:root@mysql/test
    links:
      - mysql
      - zookeeper
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "127.0.0.1:6033/prometheus"]
      interval: 10s
      timeout: 2s
      retries: 5
      start_period: 5s
  node:
    image: node:15.12.0
    environment:
      ZOOKEEPER_HOST: zookeeper
      DEPLOYMENT: jstests
    links:
      - mysql
      - zookeeper
      - noria-server
    volumes:
      - ../..:/js-client
    depends_on:
      noria-server:
        condition: service_healthy
    working_dir: /js-client
    command: /bin/bash -c "yarn install && yarn run test"
