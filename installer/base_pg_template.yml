version: "3.8"
volumes:
  readyset-server-state:
services:
  consul:
    healthcheck:
      test: ["CMD", "nc", "-vz", "localhost", "8500"]
      interval: 10s
      timeout: 2s
      retries: 5
      start_period: 5s
  postgres:
    expose:
      - 5432
    environment:
      POSTGRES_PASSWORD: noria
      POSTGRES_DB: noria
    depends_on:
      consul:
        condition: service_healthy
    command:
      - "postgres"
      - "-c"
      - "wal_level=logical"
    healthcheck:
      test: ["CMD", "pg_isready", "-h127.0.0.1", "--port=5432"]
      start_period: 5s
      interval: 10s
      timeout: 10s
      retries: 2
  readyset-server:
    expose:
      - "32768-60999"
    environment:
      AUTHORITY_ADDRESS: consul:8500
      AUTHORITY: consul
      LISTEN_ADDRESS: 0.0.0.0
      EXTERNAL_ADDRESS: readyset-server
      NORIA_DEPLOYMENT: noria
      REPLICATION_URL: mysql://root:noria@mysql/noria
      PROMETHEUS_METRICS: 1
      EXPERIMENTAL_TOPK_SUPPORT: 1
      FORBID_FULL_MATERIALIZATION: 1
      DB_DIR: /state
    links:
      - postgres
      - consul
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - readyset-server-state:/state
    healthcheck:
      test: ["CMD", "curl", "--fail", "127.0.0.1:6033/prometheus"]
      interval: 10s
      timeout: 2s
      retries: 5
      start_period: 5s
  readyset-adapter:
    expose:
      - 5433
    environment:
      AUTHORITY_ADDRESS: consul:8500
      AUTHORITY: "consul"
      LISTEN_ADDRESS: 0.0.0.0:5433
      NORIA_DEPLOYMENT: noria
      UPSTREAM_DB_URL: postgresql://postgres:noria@postgres/noria
      PROMETHEUS_METRICS: 1
      QUERY_LOG: 1
      QUERY_LOG_AD_HOC: 1
    links:
      - readyset-server
      - postgres
      - consul
    depends_on:
      readyset-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-h127.0.0.1", "--port=5433"]
      start_period: 5s
      interval: 10s
      timeout: 10s
      retries: 2
