version: "3.8"
volumes:
  readyset-server-state:
services:
  consul:
    healthcheck:
      test: ["CMD", "nc", "-vz", "localhost", "8500"]
      interval: 10s
      timeout: 2s
      retries: 5
      start_period: 5s
  mysql:
    expose:
      - 3306
    environment:
      MYSQL_DATABASE: noria
      MYSQL_ROOT_PASSWORD: noria
    depends_on:
      consul:
        condition: service_healthy
    healthcheck:
      test: "mysqladmin ping -h127.0.0.1 --port=3306 -uroot -pnoria"
      start_period: 10s
      interval: 10s
      timeout: 2s
      retries: 5
  readyset-adapter:
    expose:
      - 3307
    environment:
      AUTHORITY_ADDRESS: consul:8500
      AUTHORITY: "consul"
      LISTEN_ADDRESS: 0.0.0.0:3307
      NORIA_DEPLOYMENT: noria
      UPSTREAM_DB_URL: mysql://root:noria@mysql/noria
      PROMETHEUS_METRICS: 1
      QUERY_LOG: 1
      QUERY_LOG_AD_HOC: 1
      NORIA_SERVER: 1
    links:
      - mysql
      - consul
    volumes:
      - readyset-server-state:/state
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h127.0.0.1", "--port=3307", "-uroot", "-pnoria"]
      interval: 10s
      timeout: 10s
      retries: 2
      start_period: 5s
  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    healthcheck:
      test: ["CMD", "nc", "-vz", "localhost", "9090"]
      interval: 10s
      timeout: 2s
      retries: 5
      start_period: 5s 
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - 9090:9090
  pushgateway:
    image: prom/pushgateway
  grafana:
    image: grafana/grafana:8.0.6
    volumes:
      - ./grafana/dashboards:/var/lib/grafana/dashboards
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/config/grafana.ini:/etc/grafana/grafana.ini
    ports:
      - 4000:4000
  vector:
    image: timberio/vector:0.16.1-debian
    volumes:
      - ./vector/aggregator.toml:/etc/vector/vector.toml
