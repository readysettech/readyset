steps:
  - label: ':git: Lint commits'
    key: lint-commits
    commands:
    - ./scripts/commit_lint.sh

  # Do not run pipeline if the lint has not passed
  - wait: ~

  - label: ":partyparrot: Creating the pipeline"
    plugins:
      - Zegocover/git-diff-conditional#v1.1.1:
          log_level: DEBUG
          dynamic_pipeline: ".buildkite/common.yaml"
          steps:
            - label: ':docker: Build build image'
              exclude:
                - "ops/**"

            - label: ':rust: Check rustfmt'
              exclude:
                - "ops/**"

            - label: ':prettier: Check prettier'

            - label: ':clippy: Check clippy'
              exclude:
                - "ops/**"

            - label: ':rust: Build noria-logictest'
              exclude:
                - "ops/**"

            - label: ':rust: Test noria-logictest'
              exclude:
                - "ops/**"

            - label: ':rust: Build query-generator'
              exclude:
                - "ops/**"

            - label: ':rust: Build taster'
              exclude:
                - "ops/**"

            - label: ':rust: Test taster'
              exclude:
                - "ops/**"

            - label: ':rust: Build launchpad'
              exclude:
                - "ops/**"

            - label: ':rust: Test launchpad'
              exclude:
                - "ops/**"

            - label: ':rust: Build nom-sql'
              exclude:
                - "ops/**"

            - label: ':rust: Test nom-sql'
              exclude:
                - "ops/**"

            - label: ':rust: Build unbounded-interval-tree'
              exclude:
                - "ops/**"

            - label: ':rust: Test unbounded-interval-tree'
              exclude:
                - "ops/**"

            - label: ':rust: Build noria'
              exclude:
                - "ops/**"

            - label: ':rust: Test noria'
              exclude:
                - "ops/**"

            - label: ':rust: Build noria-client'
              exclude:
                - "ops/**"

            - label: ':rust: Test noria-client'
              exclude:
                - "ops/**"

            - label: ':rust: Build noria-client-adapter'
              exclude:
                - "ops/**"

            - label: ':rust: Build noria-mysql'
              exclude:
                - "ops/**"

            - label: ':rust: Test noria-mysql'
              exclude:
                - "ops/**"

            - label: ':rust: Build noria-psql'
              exclude:
                - "ops/**"

            - label: ':rust: Test noria-psql'
              exclude:
                - "ops/**"

            - label: 'Run logictest'
              exclude:
                - "ops/**"

            - label: ':rust: Build debezium connector'
              exclude:
                - "ops/**"

            - label: ':rust: Test debezium connector'
              exclude:
                - "ops/**"

            - label: ':rust: Build msql-srv'
              exclude:
                - "ops/**"

            - label: ':rust: Test msql-srv'
              exclude:
                - "ops/**"

            - label: ':rust: Build psql-srv'
              exclude:
                - "ops/**"

            - label: ':rust: Test psql-srv'
              exclude:
                - "ops/**"

            - label: ':rust: Deploy docs'
              exclude:
                - "ops/**"

            - label: ':terraform: Terraform fmt'
              include:
                - "ops/**"

            - label: ':terraform: Terraform validate'
              include:
                - "ops/**"

            - label: ':terraform: Check terraform best-practices'
              include:
                - "ops/**"

  - block: ":rocket: :rust: Build release binaries?"
    key: build-release-binaries
    depends_on:
      - lint-commits
      - build-image
      - check-rustfmt
      - check-clippy
      - build-noria-logictest
      - test-noria-logictest
      - build-query-generator
      - build-taster
      - test-taster
      - build-launchpad
      - test-launchpad
      - build-nom-sql
      - test-nom-sql
      - build-unbounded-interval-tree
      - unbounded-interval-tree
      - build-noria
      - test-noria
      - build-noria-client
      - test-noria-client
      - build-noria-client-adapter
      - build-noria-mysql
      - test-noria-mysql
      - build-noria-psql
      - test-noria-psql
      - logictest
      - build-debezium-connector
      - test-debezium-connector
      - build-msql-srv
      - test-mssql-srv
      - build-psql-srv
      - test-psql-srv

  - label: ':rust: Build noria-server release binary'
    key: build-noria-release
    commands:
    - 'echo +++ :rust: Running cargo build'
    - RUSTFLAGS='-D warnings' cargo build --release --bin noria-server
    - strip target/release/noria-server
    artifact_paths:
    - target/release/noria-server
    depends_on:
    - build-image
    - build-release-binaries
    plugins:
      - docker#v3.7.0:
          image: '069491470376.dkr.ecr.us-east-2.amazonaws.com/noria-build:latest'
          volumes:
          - 'cargo-registry:/usr/local/cargo/registry'
          - 'cargo-registry:/usr/local/cargo/registry'
          environment:
          - SCCACHE_BUCKET=readyset-sccache-e1
          - AWS_IAM_CREDENTIALS_URL=http://169.254.169.254/latest/meta-data/iam/security-credentials/buildkite-Role
          - CARGO_INCREMENTAL=0
      - ecr#v2.2.0:
          login: true

  - label: ':rust: Build noria-mysql release binary'
    key: build-noria-mysql-release
    commands:
    - 'echo +++ :rust: Running cargo build'
    - RUSTFLAGS='-D warnings' cargo build --release --bin noria-mysql
    - strip target/release/noria-mysql
    artifact_paths:
    - target/release/noria-mysql
    depends_on:
    - build-image
    - build-release-binaries
    plugins:
      - docker#v3.7.0:
          image: '069491470376.dkr.ecr.us-east-2.amazonaws.com/noria-build:latest'
          volumes:
          - 'cargo-registry:/usr/local/cargo/registry'
          - 'cargo-registry:/usr/local/cargo/registry'
          environment:
          - SCCACHE_BUCKET=readyset-sccache-e1
          - AWS_IAM_CREDENTIALS_URL=http://169.254.169.254/latest/meta-data/iam/security-credentials/buildkite-Role
          - CARGO_INCREMENTAL=0
      - ecr#v2.2.0:
          login: true

  - label: ':rust: Build debezium_connector release binary'
    key: build-debezium-connector-release
    commands:
    - 'echo +++ :rust: Running cargo build'
    - RUSTFLAGS='-D warnings' cargo build --release --bin debezium_connector
    - strip target/release/debezium_connector
    artifact_paths:
    - target/release/debezium_connector
    depends_on:
    - build-image
    - build-release-binaries
    plugins:
      - docker#v3.7.0:
          image: '069491470376.dkr.ecr.us-east-2.amazonaws.com/noria-build:latest'
          volumes:
          - 'cargo-registry:/usr/local/cargo/registry'
          - 'cargo-registry:/usr/local/cargo/registry'
          environment:
          - SCCACHE_BUCKET=readyset-sccache-e1
          - AWS_IAM_CREDENTIALS_URL=http://169.254.169.254/latest/meta-data/iam/security-credentials/buildkite-Role
          - CARGO_INCREMENTAL=0
      - ecr#v2.2.0:
          login: true

  - block: ":packer: Build Packer images?"
    key: build-packer-images
    depends_on:
      - build-noria-release
      - build-noria-mysql-release
      - build-debezium-connector-release

  - label: ':pipeline: Build Packer pipeline'
    command: .buildkite/build-packer-images.sh | buildkite-agent pipeline upload
    depends_on:
      - build-packer-images
