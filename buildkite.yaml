steps:
  - label: ':git: Lint commits'
    key: lint-commits
    branches: '!master'
    commands:
    - ./scripts/commit_lint.sh

  # Do not run pipeline if the lint has not passed
  - wait: ~

  - label: ":partyparrot: Creating the pipeline"
    plugins:
      - Zegocover/git-diff-conditional#v1.1.1:
          log_level: DEBUG
          dynamic_pipeline: ".buildkite/common.yaml"
          steps:
            - label: ':docker: Build build image'
              exclude:
                - "ops/**"

            - label: ':rust: Check rustfmt'
              exclude:
                - "ops/**"

            - label: ':docker: Build prettier image'
              exclude:
                - "js-client/**"

            - label: ':prettier: Check prettier'
              exclude:
                - "js-client/**"

            - label: ':docker: Build cargo-audit image'
              include:
                - 'Cargo.lock'

            - label: ':rust: :lock: Check cargo-audit'
              include:
                - 'Cargo.lock'

            - label: ':clippy: Check clippy'
              exclude:
                - "ops/**"

            - label: ":docker: Build noria-server image"
              include:
                - "js-client/**"

            - label: ":rust: Build js-client shared library"
              include:
                - "js-client/**"

            - label: ':nodejs: Test js-client'
              include:
                - "js-client/**"

            - label: ':rust: Run tests'
              exclude:
                - "ops/**"

            - label: 'Run logictest'
              exclude:
                - "ops/**"

            - label: 'Run logictest with binlog replication'
              exclude:
                - "ops/**"

            - label: ':rust: Deploy docs'
              exclude:
                - "ops/**"

            - label: ':terraform: Terraform fmt'
              include:
                - "ops/**"

            - label: ':terraform: Terraform validate'
              include:
                - "ops/**"

            - label: ':terraform: Check terraform best-practices'
              include:
                - "ops/**"

            - label: ':packer: Lint Packer configuration'
              include:
                - "ops/images/**"

            - label: ':pipeline: Build validate packer pipeline'
              include:
                - "ops/images/**"

            - label: 'List frameworks'
              include:
                - "readyset-framework-testing/frameworks/**"

            - label: 'Generate framework pipeline'
              include:
                - "readyset-framework-testing/frameworks/**"

  - block: ":rocket: :rust: Build release binaries?"
    key: build-release-binaries
    depends_on:
      - lint-commits
      - build-image
      - check-rustfmt
      - check-clippy
      - rust-tests
      - logictest
      - logictest-binlog

  - label: ':rust: Build noria-server release binary'
    key: build-noria-release
    commands:
    - 'echo +++ :rust: Running cargo build'
    - RUSTFLAGS='-D warnings' cargo build --release --bin noria-server
    - strip target/release/noria-server
    artifact_paths:
    - target/release/noria-server
    depends_on:
    - build-image
    - build-release-binaries
    plugins:
      - docker#v3.7.0:
          image: '069491470376.dkr.ecr.us-east-2.amazonaws.com/noria-build:latest'
          volumes:
          - 'cargo-registry:/usr/local/cargo/registry'
          - 'cargo-registry:/usr/local/cargo/registry'
          environment:
          - SCCACHE_BUCKET=readyset-sccache-e1
          - AWS_IAM_CREDENTIALS_URL=http://169.254.169.254/latest/meta-data/iam/security-credentials/buildkite-Role
          - CARGO_INCREMENTAL=0
      - ecr#v2.2.0:
          login: true

  - label: ':rust: Build noria-mysql release binary'
    key: build-noria-mysql-release
    commands:
    - 'echo +++ :rust: Running cargo build'
    - RUSTFLAGS='-D warnings' cargo build --release --bin noria-mysql
    - strip target/release/noria-mysql
    artifact_paths:
    - target/release/noria-mysql
    depends_on:
    - build-image
    - build-release-binaries
    plugins:
      - docker#v3.7.0:
          image: '069491470376.dkr.ecr.us-east-2.amazonaws.com/noria-build:latest'
          volumes:
          - 'cargo-registry:/usr/local/cargo/registry'
          - 'cargo-registry:/usr/local/cargo/registry'
          environment:
          - SCCACHE_BUCKET=readyset-sccache-e1
          - AWS_IAM_CREDENTIALS_URL=http://169.254.169.254/latest/meta-data/iam/security-credentials/buildkite-Role
          - CARGO_INCREMENTAL=0
      - ecr#v2.2.0:
          login: true

  - label: ':s3: Set release binary version in S3'
    key: set-release-version
    commands:
    - .buildkite/set-release-version.sh
    depends_on:
    - build-noria-release
    - build-noria-mysql-release
    env:
      DEPLOY_ARTIFACTS_BUCKET: readysettech-deploy-artifacts-us-west-2/readyset

  - block: ":packer: Build Packer images?"
    key: build-packer-images
    depends_on: []

  - label: ':pipeline: Build Packer pipeline'
    commands:
    - .buildkite/build-packer-images.sh | buildkite-agent pipeline upload
    depends_on:
      - build-packer-images
    env:
      DEPLOY_ARTIFACTS_BUCKET: readysettech-deploy-artifacts-us-west-2/readyset
