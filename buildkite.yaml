steps:
  - label: ':git: Lint commits'
    commands:
    - ./scripts/commit_lint.sh

  # Do not run pipeline if the lint has not passed
  - wait: ~

  - label: ":partyparrot: Creating the pipeline"
    plugins:
      - Zegocover/git-diff-conditional#v1.1.1:
          log_level: DEBUG
          dynamic_pipeline: ".buildkite/common.yaml"
          steps:
            - label: ':docker: Build build image'
              exclude:
                - "ops/**"

            - label: ':rust: Check rustfmt'
              exclude:
                - "ops/**"

            - label: ':clippy: Check clippy'
              exclude:
                - "ops/**"

            - label: ':rust: Build noria-logictest'
              exclude:
                - "ops/**"

            - label: ':rust: Test noria-logictest'
              exclude:
                - "ops/**"

            - label: ':rust: Build query-generator'
              exclude:
                - "ops/**"

            - label: ':rust: Build taster'
              exclude:
                - "ops/**"

            - label: ':rust: Test taster'
              exclude:
                - "ops/**"

            - label: ':rust: Build launchpad'
              exclude:
                - "ops/**"

            - label: ':rust: Test launchpad'
              exclude:
                - "ops/**"

            - label: ':rust: Build nom-sql'
              exclude:
                - "ops/**"

            - label: ':rust: Test nom-sql'
              exclude:
                - "ops/**"

            - label: ':rust: Build unbounded-interval-tree'
              exclude:
                - "ops/**"

            - label: ':rust: Test unbounded-interval-tree'
              exclude:
                - "ops/**"

            - label: ':rust: Build noria'
              exclude:
                - "ops/**"

            - label: ':rust: Test noria'
              exclude:
                - "ops/**"

            - label: ':rust: Build noria-client'
              exclude:
                - "ops/**"

            - label: ':rust: Test noria-client'
              exclude:
                - "ops/**"

            - label: ':rust: Build noria-mysql'
              exclude:
                - "ops/**"

            - label: ':rust: Test noria-mysql'
              exclude:
                - "ops/**"

            - label: ':rust: Build noria-psql'
              exclude:
                - "ops/**"

            - label: ':rust: Test noria-psql'
              exclude:
                - "ops/**"

            - label: 'Run logictest'
              exclude:
                - "ops/**"

            - label: ':rust: Build debezium connector'
              exclude:
                - "ops/**"

            - label: ':rust: Test debezium connector'
              exclude:
                - "ops/**"

            - label: ':rust: Build psql-srv'
              exclude:
                - "ops/**"

            - label: ':rust: Test psql-srv'
              exclude:
                - "ops/**"

            - label: ':rust: Deploy docs'
              exclude:
                - "ops/**"

            - label: ':terraform: Terraform fmt'
              include:
                - "ops/**"

            - label: ':terraform: Terraform validate'
              include:
                - "ops/**"

            - label: ':terraform: Check terraform best-practices'
              include:
                - "ops/**"
