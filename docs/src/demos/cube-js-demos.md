# Cube.js

_Last Updated 5/19/2022_

## Set Up ReadySet

* Clone the ReadySet repo
* Download and run the Readyset installer via `bash -c "$(curl -sSL https://launch.readyset.io)"`
* Follow the prompts and set up a MySQL Deployment when prompted
* Note the ReadySet connection string generated by the installer (we'll need it for Cube.js)
  * Example: `$ mysql -h127.0.0.1 -uroot -preadyset -P3307 --database=readyset`

## Download Example Data Set

Any decently sized dataset will do but a good option is one of the [IMBD Datasets](https://www.imdb.com/interfaces/).
For the sake of this tutorial we'll assume you're using the IMBD dataset `title.basics.tsv`.

`title.basics.tsv.gz` aContains the following fields:

    tconst (string) - alphanumeric unique identifier of the title
    titleType (string) – the type/format of the title (e.g. movie, short, tvseries, tvepisode, video, etc)
    primaryTitle (string) – the more popular title / the title used by the filmmakers on promotional materials at the point of release
    originalTitle (string) - original title, in the original language
    isAdult (boolean) - 0: non-adult title; 1: adult title
    startYear (YYYY) – represents the release year of a title. In the case of TV Series, it is the series start year
    endYear (YYYY) – TV Series end year. ‘\N’ for all other title types
    runtimeMinutes – primary runtime of the title, in minutes
    genres (string array) – includes up to three genres associated with the title

First we'll need to create a table for the entries in the tsv file we just downloaded.

Connect to the MySQL database using the connection string generated in step 1 and create a new table with the
following schema.

```mysql
create table imbd_title_basics
(
  tconst         VARCHAR(10) NOT NULL PRIMARY KEY,
  titleType      VARCHAR(50),
  primaryTitle   TEXT,
  originalTitle  TEXT,
  isAdult        BOOLEAN,
  startYear      INTEGER,
  endYear        INTEGER,
  runtimeMinutes INTEGER,
  genres TEXT
)
```

Modify `~/.local/share/readyset/compose/<deployment-name>.yml`  (the ReadySet deployment docker compose file created by
the installer) and add the following command and volume mount:

```yaml
  mysql:
...
    command: --secure-file-priv='/opt/'
...
    volumes:
      - "<dataset-mount-directory>/title.basics.tsv/data.tsv:/opt/title.basics.tsv/data.tsv"
```

_(note that these flags can be removed from the docker compose files once the data set has been loaded)_

Connect to the MySQL database and load the example dataset into the newly created table.

```mysql
load data infile '/opt/title.basics.tsv/data.tsv' into table imbd_title_basics ignore 1 lines;
```

## Set Up Cube.js

* Run a Cube.js container locally using host networking via the following command:
  ```bash
  docker run -p 4040:4000 -v ${PWD}:/cube/conf -e CUBEJS_DEV_MODE=true  --net=host cubejs/cube
  ```
  _Note we remap port 4040 to 4000 to avoid port collisions with Grafana._
* Navigate to `localhost:4040` to view Cube.js and select MySQL from the "Set Up a Database Connection" screen.
* Pass the host, username, password, and database name generated by the ReadySet installer to Cube.js using the UI
accessed at `localhost:4040` after the Cube.js container launches.

### (Optional) Make Changes to Docker Compose File

Add the following lines to `~/.local/share/readyset/compose/<deployment-name>.yml` _in lieu_ of running Cube.js using 
docker run.

```yaml
  cube:
    image: cubejs/cube:latest
    ports:
      - 4040:4000
      - 3000:3000
    environment:
      - CUBEJS_DEV_MODE=true
    volumes:
      - .:/cube/conf
```

By making these modifications you'll want to pass `readyset-adapter` for the hostname instead of the hostname generated
by the ReadySet installer for the port at the "Set Up a Database connection" prompt.