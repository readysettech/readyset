# Release Process

Currently we release software to our clients in the form of Amazon Machine
Images (AMI) built with [Packer](https://packer.io) combined with
[CloudFormation](https://aws.amazon.com/cloudformation/resources/templates/)
templates with the AMIs baked into them.

We intend to support other kinds of releases in the future, for example,
binaries, OCI containers, Helm charts, etc.

## Access restrictions

Currently access to the AMIs is restricted by a list of AWS Account IDs defined
in `ops/image-deploy/locals.pkr.hcl` under variable `customer_account_ids`

## On CLs

Since building this requires spending resources on Amazon infrastructure to
build and store the AMIs that are generated, they are not built on every CL but
can be generated from any CL.

By unblocking the step in Buildkite labeled "Build AMIs and CloudFormation
templates" AMIs are built and CloudFormation templates are uploaded to
`https://readysettech-cfn-internal-us-east-2.s3.us-east-2.amazonaws.com/<COMMIT>/readyset/templates/<TEMPLATE>.yaml`
which can be used to do manual testing from inside the Sandbox AWS account
as read permissions are configured for that purpose. There is also a script in
`ops/cfn-test/create-mysql-super-stack.sh` where you pass a commit and an SSH
key name and it will start a whole stack that you can SSH into through the
bastion host.

TODO: Information on how to connect and clean up the stack.

There's a cursory smoke test CI step that runs against the CFN templates
generated by earlier CI stages.

You can then unblock an additional step labeled "Deploy AMIs and CloudFormation
as alpha release" which will copy the AMIs and create new templates which are
then are uploaded to a public location of
`https://readysettech-cfn-public-us-east-2.s3.us-east-2.amazonaws.com/alpha/<COMMIT>/readyset/templates/<TEMPLATE>.yaml`.
The files put to this location are public and the AMIs referred to in the
templates are only accessible to the list described under Access Restrictions

## On main

When being merged to main the "Deploy AMIs and CloudFormation as alpha release"
block step is replaced by a different step which is called "Deploy AMIs and
CloudFormation as release" which prompts for a release name. This will do the
same things except upload to
`https://readysettech-cfn-public-us-east-2.s3.us-east-2.amazonaws.com/<RELEASE>/readyset/templates/<TEMPLATE>.yaml`.
which can then be shared with the customers.
