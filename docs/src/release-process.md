# Release Process

Currently we release software to our clients in the form of Amazon Machine
Images (AMI) built with [Packer](https://packer.io) combined with
[CloudFormation](https://aws.amazon.com/cloudformation/resources/templates/)
templates with the AMIs baked into them.

We intend to support other kinds of releases in the future, for example,
binaries, OCI containers, Helm charts, etc.

## Access restrictions

Currently access to the AMIs is restricted by a list of AWS Account IDs defined
in `ops/image-deploy/locals.pkr.hcl` under variable `customer_account_ids`

## On CLs

Since building this requires spending resources on Amazon infrastructure to
build and store the AMIs that are generated, they are not built on every CL but
can be generated from any CL.

By unblocking the step in Buildkite labeled "Build AMIs and CloudFormation
templates" AMIs are built and CloudFormation templates are uploaded to
`https://readysettech-cfn-internal-us-east-2.s3.us-east-2.amazonaws.com/<COMMIT>/readyset/templates/<TEMPLATE>.yaml`
which can be used to do manual testing from inside the Sandbox AWS account
as read permissions are configured for that purpose. There is also a script in
`ops/cfn-test/create-mysql-super-stack.sh` where you pass a commit and an SSH
key name and it will start a whole stack that you can SSH into through the
bastion host.

TODO: Information on how to connect and clean up the stack.

There's a cursory smoke test CI step that runs against the CFN templates
generated by earlier CI stages.

You can then unblock an additional step labeled "Deploy AMIs and CloudFormation
as alpha release" which will copy the AMIs and create new templates which are
then are uploaded to a public location of
`https://readysettech-cfn-public-us-east-2.s3.us-east-2.amazonaws.com/alpha/<COMMIT>/readyset/templates/<TEMPLATE>.yaml`.
The files put to this location are public and the AMIs referred to in the
templates are only accessible to the list described under Access Restrictions

## Manual Build and Release Process for the Orchestrator

This manual release process is a stopgap measure until automation is set up.

1. In a CL, update the `READYSET_TAG` and `CFN_VERSION` release constants in: `installer/src/constants.rs`. We will need this exact value later. Traditionally it is the feature SHA-1, but it should be casually unique enough to prevent colissions.

2. When that CL is merged, a new build is started on`ref/heads/main` in buildkite:
 https://buildkite.com/readyset/readyset/builds?branch=refs%2Fheads%2Fmain

3. Promote this build through all of the build steps,

4. THe last step, Deploy :amazon-ec2: AMIs and :aws-cloudformation: CloudFormation release, will prompt you for a value. Ensure you use the exact same constant as the installer constants from step 1.

This step also pushes the templates up for direct customer use at:
`https://readysettech-cfn-public-us-east-2.s3.us-east-2.amazonaws.com/<RELEASE>/readyset/templates/<TEMPLATE>.yaml`

5. While buildkite is working, you can can do manual builds of the installer binaries across linux and mac computers. DOuble-check that you're on the latest main for each computer when building.

   ```sh
   linux-computer$ cargo build --release --bin readyset-installer --target x86_64-linux-unknown-musl
   linux-computer$ strip target/x86_64-linux-musl/release/readyset-installer
   apple-computer$ cargo build --release --bin readyset-installer
   apple-computer$ strip target/release/readyset-installer
   apple-computer$ cargo build --release --bin readyset-installer --target aarch64-apple-darwin
   apple-computer$ strip target/aarch64-apple-darwin/release/readyset-installer
   ```

6. Once the buildkite run is complete, and the binaries are built, you can publish the binaries

   ```sh
   $ aws s3 cp <path-to-linux-binary> s3://readysettech-orchestrator-us-east-2/binaries/x86_64-unknown-linux-gnu
   $ aws s3 cp <path-to-apple-intel-binary> s3://readysettech-orchestrator-us-east-2/binaries/x86_64-apple-darwin
   $ aws s3 cp <path-to-apple-arm-binary> s3://readysettech-orchestrator-us-east-2/binaries/aarch64-apple-darwin
   ```

7. Deploy an updated version of the wrapper script

   ```sh
   $ aws s3 cp <readyset-monorepo>/installer/readyset-orchestrator.sh s3://readysettech-orchestrator-us-east-2/readyset-orchestrator.sh
   ```

8. Create cloudfront invalidation

   ```sh
   $ aws cloudfront create-invalidation --distribution-id EGUPZSIU4Q3J9 --paths '/*'
   ```
