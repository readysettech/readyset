# ReadySet Development Environment

## What is this?

A guide to setting up a development environment for ReadySet on Linux and MacOS.

## Ubuntu

First we discuss general consideration of what a ReadySet developer environment needs then we outline a programmatic approach
to provisioning such an environment.

### Considerations

ReadySet development environments need to be [SOC 2](https://www.imperva.com/learn/data-security/soc-2-compliance/)
compliant and there are required development and communication tools in order to work with ReadySet code.

### Required Packages

#### General Tools

The following tools will be useful for _all_ engineers.

| Package | Use |
|---------|-----|
| Slack | Canonical communication platform |
| Git | Code repository management |
| Tailscale | VPN client |
| rustup | Rust version manager |
| A browser (Firefox, Chrome, etc.) | Access G Suite utilities |
| Zoom | Most common means to host meetings (G Suite is also used) |

#### DevOps and Provisioning Tools

These packages may or may not be useful for general engineers but should be
installed for DevOps engineers.

| Package | Use |
|---------|-----|
| docker | Used for parts of the CI/CD pipeline and elsewhere |
| docker-compose | Occasionally used for internal infrastructure |
| Terraform | Provisioning internal infrastructure |
| Packer | Building AMIs and other machine images |

#### Common "Gotchas"

* All storage devices containing ReadySet code must be _at rest_ encrypted.
* SSH keys must be encrypted (via `ssh-keygen -t ed25519 -C <user name>-<RFC 3339 date>@readyset.io` or similar and included a password).

## Canonical Development Environment

We use an Ubuntu image, defined by Packer and Cloud-Init provisioning files as way to demonstrate a canonical
development environment configuration. These files also provide a useful reference if provisioning manually or via a
different provisioning system.

The canonical environment is an Ubuntu 20.04 QEMU image that can be used as a VM or used
to provision a bare metal machine. This image uses a UEFI partitioning scheme
and full disk encryption via `dm-crypt` in order to meet certain SOC 2 _in situ_ encryption requirements.
Further the image installs all required development and communication tools during installation.

### Pre-Reqs

The following packages will need to be installed in order to build a canonical development environment image
locally.

* packer
* KVM / QEMU

### Project Layout

```text
├── http # Ubuntu 2x.xx autoinstall files
│   ├── meta-data # Empty but required for builds
│   └── user-data # Describes machine state of canonical reference image
└── ubuntu-22.04-uefi.pkr.hcl # Canonical reference image build steps 
```


### Building an Image

`packer build ./ubuntu-22.04-uefi.pkr.hcl -var "output_directory=<directory for generated image>"`

Note `ubuntu-22.04-uefi.pkr.hcl` defines many more configuration variables than `output_directory` which
may or may not be useful to set.

### System Variables

| Variable     | Default      |
|--------------|--------------|
| Host Name    | readyset-dev |
| User Name    | readyset     |
| Password     | change       |
| DM Crypt Key | change       |

* Note these variables are all set within `./http/user-data`
* Password _must_ be in crypted format which can be accomplished via
  `printf '<password>' | openssl passwd -6 -salt 'FhcddHFVZ7ABA4Gi' -stdin` or similar

### Copying to Physical Media

The raw disk image generated by packer can either be run as a QEMU virtual machine or copied onto
physical media to run on a bare metal system.

Since we're working with raw disk images we copy the entire generated disk over using a command like `dd`:
```shell
dd if=/<path to disk image>/canonical_readyset_dev of=/dev/sd<X> bs=4k
```

Where `sd<X>` corresponds to the dev file for a physical device like a hard drive, USB stick etc.

As with anything involving `dd` be _extremely cautious_ about identifying the correct dev file before running the command.

Further once the disk image is copied over you'll need to re-size the root partition in order to fill the physical media completely.

### Further Reading

Ubuntu 2x.xx autoinstall is fairly opaque; below are some resources to reference:

* [Ubuntu autoinstall quick start](https://ubuntu.com/server/docs/install/autoinstall-quickstart)
* [Github project showing packer templates for Ubuntu 18.xx and 2x.xx](https://github.com/tylert/packer-build/tree/master/source/ubuntu)

## Things to do after installation

* Login to G Suite with ReadySet credentials
* Login to Slack
* Download Kolide via the Slack bot prompts (accessed via Apps => Kolide)
* Run Tailscale with root privileges via `tailscale up --accept-dns`
    * Tailscale _must_ be up in order to access Gerrit
* Set a username in Gerrit, which is _required_ to pull the Mono Repo or submit change lists
* Generate an encrypted SSH key if you haven't already and copy it into Gerrit
    * The ReadySet Mono Repo is located at `https://gerrit.readyset.name` or `https://gerrit` if Tailscale is up
* Clone ReadySet mono repo and download Gerrit pre-commit hooks
* Install [RustUp](https://rustup.rs/)

### Special Considerations

* When running the provided machine images with KVM you _must_ use a UEFI bios. Legacy BIOSes like SeaBIOS will not work.

### Provisioning Files

`http/user-data`

```yaml
#cloud-config
autoinstall:
  version: 1
  identity:
    hostname: readyset-dev
    # password set to 'change', see README for instructions on how to generate a new password
    password: '$6$2cKSEDLRORSftuhq$cnAVl8OFh1mt5qJmDpcPBYFcjBTM2Rb2XBruvj6alY7xu5KSgm3pbE62WjxZqnU./VL5YLj.uVRHHCjVGN/XD.'
    username: readyset
  locale: en_US
  keyboard:
    layout: us
  storage:
    swap:
      size: 0
    grub:
      reorder_uefi: False
    config:
      ### drive
      - id: disk-0
        grub_device: false
        type: disk
        ptable: gpt
        wipe: superblock
      - id: efi_boot_partition
        type: partition
        size: 512M
        grub_device: true
        device: disk-0
        flag: boot
      - id: boot_partition
        type: partition
        size: 1G
        device: disk-0
      - id: root_partition
        type: partition
        size: -1
        device: disk-0
      ### format and mount efi partitions
      - id: efi_vfat
        type: format
        fstype: fat32
        volume: efi_boot_partition
      - id: efi_boot_mount
        type: mount
        path: /boot/efi
        device: efi_vfat
      ### format and mount boot partition
      - id: boot_ext4
        type: format
        fstype: ext4
        volume: boot_partition
      - id: boot_mount
        type: mount
        path: /boot
        device: boot_ext4
      ### Format Encrypted LUKS Drive
      - id: dm_crypt-0
        type: dm_crypt
        preserve: false
        key: 'change'
        volume: root_partition
      - id: lvm_volgroup-0
        name: ubuntu-vg
        devices: [dm_crypt-0]
        preserve: false
        type: lvm_volgroup
      - id: lvm_partition-0
        name: ubuntu-lv
        volgroup: lvm_volgroup-0
        size: 100%
        preserve: false
        type: lvm_partition
      - id: lvm_ext4
        fstype: ext4
        volume: lvm_partition-0
        preserve: false
        type: format
      - id: root_mount
        type: mount
        path: /
        device: lvm_ext4
  apt:
    preserve_sources_list: false
    primary:
      - arches: [amd64, i386]
        uri: http://us.archive.ubuntu.com/ubuntu
      - arches: [default]
        uri: http://ports.ubuntu.com/ubuntu-ports
    sources:
      tailscale:
        source: deb https://pkgs.tailscale.com/stable/ubuntu focal main
        # PGP copied from https://pkgs.tailscale.com/stable/ubuntu/focal.gpg
        key: |
          -----BEGIN PGP PUBLIC KEY BLOCK-----

          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
          =AIVM
          -----END PGP PUBLIC KEY BLOCK-----
      hashicorp:
        source: deb [arch=amd64] https://apt.releases.hashicorp.com focal main
        # PGP copied from https://apt.releases.hashicorp.com/gpg
        key: |
          -----BEGIN PGP PUBLIC KEY BLOCK-----

          mQINBF60TuYBEADLS1MP7XrMlRkn1Y54cb2UclUMH8HkIRfBrhk5Leo9kNZc/2QD
          LmdQbi3UbZkz0uVkHqbFDgV5lAnukCnxgr9BqnL0GJpO78le7gCCbM5bR4rTJ6Ar
          OOtIKf25smGTIpbSwNdj8BOLqiExGFj/9L5X9S5kfq3vtuYt+lmxKkIrEPjSYnFR
          TQ2mTL8RM932GJod/5VJ2+6YvrCjtPu5/rW02H1U2ZHiTtX6ZGnIvv/sprKyFRqT
          x4Ib+o9XwXof/LuxTMpVwIHSzCYanH5hPc7yRGKzIntBS+dDom+h9smx7FTgpHwt
          QRFGLtVoHXqON6nXTLFDkEzxr+fXq/bgB1Kc1TuzvoK601ztQGhhDaEPloKqNWM8
          Ho7JU1RpnoWr5jOFTYiPM9uyCtFNsJmD9mt4K8sQQN7T2inR5Us0o510FqePRFeX
          wOJUMi1CbeYqVHfKQ5cWYujcK8pv3l1a6dSBmFfcdxtwIoA16JzCrgsCeumTDvKu
          hOiTctb28srL/9WwlijUzZy6R2BGBbhP937f2NbMS/rpby7M1WizKeo2tkKVyK+w
          SUWSw6EtFJi7kRSkH7rvy/ysU9I2ma88TyvyOgIz1NRRXYsW7+brgwXnuJraOLaB
          5aiuhlngKpTPvP9CFib7AW2QOXustMZ7pOUREmxgS4kqxo74CuFws163TwARAQAB
          tFFIYXNoaUNvcnAgU2VjdXJpdHkgKEhhc2hpQ29ycCBQYWNrYWdlIFNpZ25pbmcp
          IDxzZWN1cml0eStwYWNrYWdpbmdAaGFzaGljb3JwLmNvbT6JAk4EEwEIADgWIQTo
          oDLglNjrTqGJ0nDaQYyIoyGfewUCXrRO5gIbAwULCQgHAgYVCgkICwIEFgIDAQIe
          AQIXgAAKCRDaQYyIoyGfe6/WD/9dTM/1OSgbvSPpPJOOcn5L1nOKRBJpztr4V0ky
          GoCDakIQ/sykbcuHXP79FGLzrM8zQOsbvVp/Z2lsWBnxkT8KWM+8LZxYToRGdZhr
          huFPHV9df0vAsZGisu4ejHDneHOTO3KqVotkky34jUSjBL7Q8uwXHY9r+5hb452N
          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
          =emKC
          -----END PGP PUBLIC KEY BLOCK-----
  packages:
    - ubuntu-desktop
    - snapd
    - curl
    - git
    - ca-certificates
    - build-essential
    - llvm
    - clang
    - libclang-dev
    - lld
    - cmake
    - libssl-dev
    - liblz4-dev
    - curl
    - docker.io
    - docker-compose
    - gparted
    - firefox
    - tailscale
    - terraform
    - packer
    - slack
  snaps:
    - name: zoom-client
      channel: edge
      classic: false
  late-commands:
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - poweroff
```

`http/meta-data`

A blank file.

`ubuntu-22.04-uefi.pkr.hcl`

```hcl
packer {
  required_version = "> 1.7.7"
}

variable "autoinstall" {
  type    = string
  default = "autoinstall.yaml"
}

variable "cpu" {
  type    = string
  default = "2"
}

variable "disk_size" {
  type    = string
  default = "40000"
}

variable "hostname" {
  type    = string
  default = "readyset-dev"
}

variable "iso_checksum" {
  type    = string
  default = "84aeaf7823c8c61baa0ae862d0a06b03409394800000b3235854a6b38eb4856f"
}

variable "iso_checksum_type" {
  type    = string
  default = "sha256"
}

variable "iso_name" {
  type    = string
  default = "ubuntu-22.04-live-server-amd64.iso"
}

variable "iso_path" {
  type    = string
  default = "iso"
}

variable "iso_url" {
  type    = string
  default = "https://releases.ubuntu.com/22.04/ubuntu-22.04-live-server-amd64.iso"
}

variable "output_directory" {
  type    = string
  default = "./build"
}

variable "password" {
  type    = string
  default = "change"
}

variable "ram_size" {
  type    = string
  default = "4096"
}

variable "username" {
  type    = string
  default = "readyset"
}

variable "vm_name" {
  type    = string
  default = "canonical_readyset_dev"
}

source "qemu" "kvm_image" {
  accelerator = "kvm"
  boot_command = [
    "<esc><esc><esc><esc>e<wait>",
    "<del><del><del><del><del><del><del><del>",
    "<del><del><del><del><del><del><del><del>",
    "<del><del><del><del><del><del><del><del>",
    "<del><del><del><del><del><del><del><del>",
    "<del><del><del><del><del><del><del><del>",
    "<del><del><del><del><del><del><del><del>",
    "<del><del><del><del><del><del><del><del>",
    "<del><del><del><del><del><del><del><del>",
    "<del><del><del><del><del><del><del><del>",
    "<del><del><del><del><del><del><del><del>",
    "<del><del><del><del><del><del><del><del>",
    "<del><del><del><del><del><del><del><del>",
    "<del><del><del><del><del><del><del><del>",
    "<del><del><del><del><del><del><del><del>",
    "<del>",
    "linux /casper/vmlinuz --- autoinstall ds=\"nocloud-net;seedfrom=http://{{.HTTPIP}}:{{.HTTPPort}}/\"<enter><wait>",
    "initrd /casper/initrd<enter><wait>",
    "boot<enter>",
    "<enter><f10><wait>"
  ]
  boot_wait               = "5s"
  communicator            = "none"
  shutdown_timeout        = "30m"
  disk_interface          = "virtio"
  disk_size               = var.disk_size
  format                  = "raw"
  headless                = false
  http_directory          = "http"
  iso_checksum            = var.iso_checksum
  iso_url                 = var.iso_url
  net_device              = "virtio-net"
  output_directory        = var.output_directory
  pause_before_connecting = "1m"
  machine_type            = "q35"
  qemuargs = [
    ["-vga", "virtio"],
    ["-m", "${var.ram_size}"],
    ["-smp", "${var.cpu}"],
    ["-bios", "OVMF.fd"],
  ]
  shutdown_command = "echo ${var.password} | sudo -S -E shutdown -P now"
  vm_name          = "${var.vm_name}"
}

build {
  sources = ["source.qemu.kvm_image"]
}
```

## MacOS

Run this script on a fresh MacOS install to get commonly used general and development software.
Re-running this script is ok; you will be notified if a dependency is already installed.

## Provisioning Files

```bash
#! /usr/bin/env zsh

typeset -a general_homebrew_packages
general_homebrew_packages=('tailscale' 'slack' 'zoom' 'firefox' 'google-chrome')
typeset -a dev_homebrew_packages
dev_homebrew_packages=('rustup' 'git' 'homebrew/cask/docker' 'awscli' 'packer' 'docker-compose' 'lz4')
typeset -a ops_homebrew_packages
ops_homebrew_packages=('python' 'terraform' 'rain')

printf "Installing xcode command line tools - watch for an OS prompt"
xcode-select --install

printf "Installing homebrew from https://brew.sh ... "
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

printf "Installing general dependencies"
for package in "${general_homebrew_packages[@]}"
do
  brew install "$package"
done

printf "Installing developer dependencies"
for package in "${dev_homebrew_packages[@]}"
do
  brew install "$package"
done

printf "Installing operations dependencies"
for package in "${ops_homebrew_packages[@]}"
do
  brew install "$package"
done
pip3 install taskcat --user # for CFN testing

printf "
Post-Install Manual Setup:
* All users:
  - Tailscale: VPN Software
    * Click the 'Tailscale' icon the top-right status bar
      -  Looks like nine dots with a 'warning' symbol
    * Select 'Log in' from the menu, which will open a browser window
    * Choose 'Sign in with Google'
  - Zoom: Meeting Video
    * Sign in with Google
    * Options to minimize 'Oops' moments
      - Audio
        * Enable Automatically join computer audio when joining a meeting
        * Enable Mute my mic when joining a meeting
      - Video
        * Enable Stop my video when joining a meeting
  - Set your default browser; Chrome and Firefox should be installed :)
* Developers:
  - Environment Variables
    * `PATH`: Add `/opt/homebrew/bin`
    * `LIBRARY_PATH`: Add `/opt/homebrew/lib`
  - awscli
    * Contact @harley to get a new IAM user set up in AWS
    * Run 'aws configure' to set up your local CLI
"
```