---
- name: Enable IPv4 forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    sysctl_set: true
    state: present
    reload: true

- name: Add Tailscale Apt Key
  apt_key:
    url: https://pkgs.tailscale.com/stable/ubuntu/focal.gpg

- name: Add Tailscale Apt Repository
  apt_repository:
    repo: deb https://pkgs.tailscale.com/stable/ubuntu focal main

- name: Install Tailscale Package
  package:
    name: tailscale
    state: present
    update_cache: true

- name: Enable Tailscale service
  service:
    name: tailscaled
    enabled: true

- name: Copy tailscale-autoconnect script
  copy:
    src: usr_local_bin_tailscale-autoconnect
    dest: /usr/local/bin/tailscale-autoconnect
    mode: u=rwx,g=rx,o=rx

- name: Copy tailscale-autoconnect service unit file
  copy:
    src: etc_systemd_system_tailscale-autoconnect.service
    dest: /etc/systemd/system/tailscale-autoconnect.service
    mode: u=rwx,g=rx,o=rx

- name: Enable Tailscale Autoconnect service
  service:
    name: tailscale-autoconnect
    enabled: true
