AWSTemplateFormatVersion: "2010-09-09"

Description: ReadySet for PostgreSQL

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: VPC Network Configuration
        Parameters:
          - VPCID
          - VPCPrivateSubnetIds
          - ReadySetServerSecurityGroupID
          - ReadySetAdapterSecurityGroupID
      - Label:
          default: SSH Access Configuration
        Parameters:
          - KeyPairName
      - Label:
          default: Consul Configuration
        Parameters:
          - ConsulJoinManagedPolicyArn
          - ConsulEc2RetryJoinTagKey
          - ConsulEc2RetryJoinTagValue
      - Label:
          default: ReadySet Configuration
        Parameters:
          - ReadySetAdapterInstanceType
          - ReadySetAdapterNodes
          - ReadySetServerInstanceType
          - ReadySetServerNodes
          - ReadySetServerInitialVolumeSizeGB
          - ReadySetServerAutoGrowVolume
          - ReadySetServerMaxVolumeSizeGB
          - ReadySetMemoryLimitGB
          - ReadySetDeploymentName
          - ReadySetLogLevel
          - ReadySetAdapterExtraEnvironment
          - ReadySetServerExtraEnvironment
      - Label:
          default: DB Configuration
        Parameters:
          - DatabaseHostname
          - DatabasePort
          - DatabaseName
          - DatabaseAdapterUsername
          - SSMParameterKmsKeyArn
          - SSMPathRDSDatabasePassword
      - Label:
          default: Logging and Metrics
        Parameters:
          - EnableCloudwatch
          - EnableAggregation

Parameters:
  ReadySetAdapterInstanceType:
    Description: The EC2 instance type to use for ReadySet Adapter instances.
    Type: String
    Default: m5.large
    AllowedPattern: ^(\w)5.*
    ConstraintDescription: Instance type must be 5th generation.

  ReadySetServerInstanceType:
    Description: The EC2 instance type to use for ReadySet Server instances.
    Type: String
    Default: c5.4xlarge
    AllowedPattern: ^(\w)5.*
    ConstraintDescription: Instance type must be 5th generation.

  ReadySetAdapterNodes:
    Description: Number of Adapter nodes to create.
    Type: String
    Default: 3
    AllowedPattern: ^\d+$

  ReadySetServerNodes:
    Description: Number of Server nodes to create.
    Type: String
    Default: 3
    AllowedPattern: ^\d+$

  ReadySetServerSecurityGroupID:
    Description: ID of the security group to apply to ReadySet Server instances.
    Type: AWS::EC2::SecurityGroup::Id

  ReadySetAdapterSecurityGroupID:
    Description: ID of the security group to apply to ReadySet Adapter instances.
    Type: AWS::EC2::SecurityGroup::Id

  ReadySetServerInitialVolumeSizeGB:
    Description: Initial volume size, in gigabytes, to provision for Server instances. This should match the EBS volume size of the RDS instance.
    Type: Number
    Default: 32
    MinValue: 32

  ReadySetServerAutoGrowVolume:
    Description: Automatically grow the volume for the ReadySet server.
    Type: String
    AllowedValues:
      - "true"
      - "false"
    Default: "true"

  ReadySetServerMaxVolumeSizeGB:
    Description: Maximum volume size, in gigabytes, to grow the volume to. If set to zero the volume will have no maximum size. Ignored if ReadySetServerAutoGrowVolume is false
    Type: Number
    Default: 0

  ReadySetMemoryLimitGB:
    Description: Memory limit for readyset server instances, in gigabytes. This should generally be set to around 80% of the memory available on the instance. A memory limit of 0 (the default) disables eviction entirely.
    Type: Number
    Default: 0
    MinValue: 0

  ReadySetDeploymentName:
    Description: A unique name for the ReadySet deployment. This is used to differentiate multiple ReadySet deployments with the same Consul cluster
    Type: String
    MinLength: 1
    AllowedPattern: ^[^/ ]+$
    ConstraintDescription: Must be non-empty and cannot contain slashes ("/") or spaces

  ReadySetLogLevel:
    Description: A log level directive as defined by tracing env-filter.
    Type: String
    Default: info

  ReadySetAdapterExtraEnvironment:
    Description: Extra environment variables to pass to the ReadySet Adapter process, separated by commas
    Type: String
    Default: ""

  ReadySetServerExtraEnvironment:
    Description: Extra environment variables to pass to the ReadySet Server process, separated by commas
    Type: String
    Default: ""

  KeyPairName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instances.
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: Must be the name of an existing EC2 KeyPair.

  VPCPrivateSubnetIds:
    Description: List of private VPC subnet IDs within the target VPC.
    Type: List<AWS::EC2::Subnet::Id>

  VPCID:
    Description: ID of the VPC to deploy resources in.
    Type: AWS::EC2::VPC::Id
    AllowedPattern: (^vpc-\w+)

  ConsulJoinManagedPolicyArn:
    Description: ARN of an managed IAM policy that the permissions to find Consul Servers
    Type: String

  ConsulEc2RetryJoinTagKey:
    Description: The EC2 instance tag key to filter on when joining to other Consul nodes.
    Type: String
    Default: ReadysetConsulNodeType
    ConstraintDescription: Must match EC2 Tag Name requirements.

  ConsulEc2RetryJoinTagValue:
    Description: The EC2 instance tag value to filter on when joining to other Consul nodes.
    Type: String
    Default: Server
    ConstraintDescription: Must match EC2 Tag Value requirements.

  DatabaseHostname:
    Description: Hostname of the MySQL server to front with ReadySet.
    Type: String

  DatabasePort:
    Description: TCP port of the MySQL server to front with ReadySet.
    Type: Number
    Default: 5432

  DatabaseProtocol:
    Description: Database connection protocol prefix for connection strings.
    Type: String
    Default: postgres

  SSMParameterKmsKeyArn:
    Description: ARN of KMS key that was used to encrypt ssm-secure parameters.
    Type: String

  DatabaseName:
    Description: Database name
    Type: String
    MinLength: 1
    MaxLength: 64
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: Must be less than 63 characters, begin with a letter, and contain only alphanumeric characters.

  DatabaseAdapterUsername:
    Description: Username to use to authenticate to the ReadySet adapter.
    Type: String
    NoEcho: true

  SSMPathRDSDatabasePassword:
    Description: Path to SSM secure string parameter that contains the backend database password.
    Type: String

  EnableCloudwatch:
    Description: Send logs and metrics directly to Cloudwatch
    Type: String
    Default: true

  EnableAggregation:
    Description: Send logs and metrics to Prometheus
    Type: String
    Default: false

Mappings:
  AWSAMIRegionMap:
    us-east-1:
      READYSETPOSTGRESQLADAPTER: ami-xxxxxxxxxxxxxxxxx #@ {readyset_psql_adapter_us_east_1}
      READYSETSERVER: ami-xxxxxxxxxxxxxxxxx #@ {readyset_server_us_east_1}
    us-east-2:
      READYSETPOSTGRESQLADAPTER: ami-xxxxxxxxxxxxxxxxx #@ {readyset_psql_adapter_us_east_2}
      READYSETSERVER: ami-xxxxxxxxxxxxxxxxx #@ {readyset_server_us_east_2}
    us-west-2:
      READYSETPOSTGRESQLADAPTER: ami-xxxxxxxxxxxxxxxxx #@ {readyset_psql_adapter_us_west_2}
      READYSETSERVER: ami-xxxxxxxxxxxxxxxxx #@ {readyset_server_us_west_2}

Resources:
  ReadySetPostgreSQLAdapterRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - !Ref ConsulJoinManagedPolicyArn
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Principal:
              Service: ec2.amazonaws.com
            Effect: Allow
            Sid: ""
      Policies:
        - PolicyName: SSMPermissions
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ssm:GetParameter*
                Resource:
                  - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${SSMPathRDSDatabasePassword}
        - PolicyName: KMSPermissions
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - kms:Decrypt*
                  - kms:Generate*
                Resource:
                  - !Ref SSMParameterKmsKeyArn

  ReadySetPostgreSQLAdapterProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref ReadySetPostgreSQLAdapterRole

  ReadySetPostgreSQLAdapterTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckProtocol: HTTP
      HealthCheckPath: /health
      HealthCheckPort: 6034
      Port: 5432
      Protocol: TCP
      VpcId: !Ref VPCID

  ReadySetPostgreSQLAdapterLC:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      InstanceType: !Ref ReadySetAdapterInstanceType
      AssociatePublicIpAddress: false
      EbsOptimized: true
      SecurityGroups:
        - !Ref ReadySetAdapterSecurityGroupID
      KeyName: !Ref KeyPairName
      ImageId: !FindInMap
        - AWSAMIRegionMap
        - !Ref AWS::Region
        - READYSETPOSTGRESQLADAPTER
      IamInstanceProfile: !Ref ReadySetPostgreSQLAdapterProfile
      UserData: !Base64
        Fn::Sub:
          - |
            Content-Type: multipart/mixed; boundary="==BOUNDARY=="
            MIME-Version: 1.0
            --==BOUNDARY==
            Content-Type: text/x-shellscript; charset="us-ascii"
            #!/bin/bash -v
            set -eu -o pipefail
            export AWS_CLOUDFORMATION_STACK="${AWS::StackName}"
            export AWS_CLOUDFORMATION_RESOURCE="ReadySetPostgreSQLAdapterASG"
            export AWS_CLOUDFORMATION_REGION="${AWS::Region}"
            export CONSUL_TAG_KEY="${ConsulEc2RetryJoinTagKey}"
            export CONSUL_TAG_VALUE="${ConsulEc2RetryJoinTagValue}"
            export DEPLOYMENT="${ReadySetDeploymentName}"
            export LOG_LEVEL="${ReadySetLogLevel}"
            export EXTRA_ENV="${ReadySetAdapterExtraEnvironment}"
            # Connection Parameters
            export SSM_PATH_DB_PASSWORD=${SSMPathRDSDatabasePassword}
            export USERNAME=${DatabaseAdapterUsername}
            export DB_PROTO=${DatabaseProtocol}
            export DB_HOST=${DatabaseHostname}
            export DB_PORT=${DatabasePort}
            export DB_NAME=${DatabaseName}
            export ENABLE_CW=${EnableCloudwatch}
            export ENABLE_AGG=${EnableAggregation}
            exec /usr/local/bin/user-data-init.sh
            --==BOUNDARY==
          - {}

  ReadySetPostgreSQLAdapterASG:
    CreationPolicy:
      AutoScalingCreationPolicy:
        MinSuccessfulInstancesPercent: 10
      ResourceSignal:
        Count: !Ref ReadySetAdapterNodes
        Timeout: PT20M
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinSuccessfulInstancesPercent: 10
        MinInstancesInService: 1
        MaxBatchSize: 1
        WaitOnResourceSignals: true
        PauseTime: PT20M
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      LaunchConfigurationName: !Ref ReadySetPostgreSQLAdapterLC
      MaxSize: !Ref ReadySetAdapterNodes
      MinSize: !Ref ReadySetAdapterNodes
      TargetGroupARNs:
        - !Ref ReadySetPostgreSQLAdapterTargetGroup
      VPCZoneIdentifier: !Ref VPCPrivateSubnetIds
      Tags:
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref AWS::StackName
              - ReadySet-PostgreSQLAdapter
          PropagateAtLaunch: true

  ReadySetPostgreSQLAdapterNLB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Type: network
      Scheme: internal
      Subnets: !Ref VPCPrivateSubnetIds

  ReadySetPostgreSQLAdapterListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      Protocol: TCP
      Port: 5432
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ReadySetPostgreSQLAdapterTargetGroup
      LoadBalancerArn: !Ref ReadySetPostgreSQLAdapterNLB

  ReadySetPostgreSQLAdapterVPCEndpointService:
    Type: AWS::EC2::VPCEndpointService
    Properties:
      NetworkLoadBalancerArns:
        - !Ref ReadySetPostgreSQLAdapterNLB

  ReadySetServerASGLifecycleTerminateSQS:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 0

  ReadySetServerASGRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AutoScalingNotificationAccessRole
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Principal:
              Service: autoscaling.amazonaws.com
            Effect: Allow
            Sid: ""

  ReadySetServerRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - !Ref ConsulJoinManagedPolicyArn
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Principal:
              Service: ec2.amazonaws.com
            Effect: Allow
            Sid: ""
      Policies:
        - PolicyName: ReadySetServerEBSVolumePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ec2:CreateVolume
                  - ec2:DescribeVolumes
                  - ec2:DescribeInstances
                  - ec2:DescribeImages
                  - ec2:CreateTags
                Resource: '*'
              - Effect: Allow
                Action:
                  - ec2:AttachVolume
                  - ec2:DetachVolume
                  - ec2:ModifyVolume
                Resource:
                  - arn:aws:ec2:*:*:volume/*
                Condition:
                  "Null":
                    aws:ResourceTag/ReadySet:ServerVolume: "false"
              - Effect: Allow
                Action:
                  - ec2:AttachVolume
                  - ec2:DetachVolume
                  - ec2:TerminateInstances
                Resource:
                  - arn:aws:ec2:*:*:instance/*
                Condition:
                  "Null":
                    aws:ResourceTag/ReadySet:ServerInstance: "false"
              - Effect: Allow
                Action:
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                Resource:
                  - !GetAtt ReadySetServerASGLifecycleTerminateSQS.Arn
              - Effect: Allow
                Action:
                  - autoscaling:CompleteLifecycleAction
                Resource: '*'
        - PolicyName: ReadySetServerHealthCheckPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - autoscaling:SetInstanceHealth
                Resource: '*'
        - PolicyName: SSMPermissions
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ssm:GetParameter*
                Resource:
                  - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${SSMPathRDSDatabasePassword}
        - PolicyName: KMSPermissions
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - kms:Decrypt*
                  - kms:Generate*
                Resource:
                  - !Ref SSMParameterKmsKeyArn

  ReadySetServerProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref ReadySetServerRole

  ReadySetServerLC:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      InstanceType: !Ref ReadySetServerInstanceType
      EbsOptimized: true
      AssociatePublicIpAddress: false
      SecurityGroups:
        - !Ref ReadySetServerSecurityGroupID
      KeyName: !Ref KeyPairName
      ImageId: !FindInMap
        - AWSAMIRegionMap
        - !Ref AWS::Region
        - READYSETSERVER
      IamInstanceProfile: !Ref ReadySetServerProfile
      UserData: !Base64
        Fn::Sub:
          - |
            Content-Type: multipart/mixed; boundary="==BOUNDARY=="
            MIME-Version: 1.0
            --==BOUNDARY==
            Content-Type: text/x-shellscript; charset="us-ascii"
            #!/bin/bash -v
            set -eu -o pipefail
            export AWS_CLOUDFORMATION_STACK="${AWS::StackName}"
            export AWS_CLOUDFORMATION_RESOURCE="ReadySetServerASG"
            export AWS_CLOUDFORMATION_REGION="${AWS::Region}"
            export SQS_QUEUE_URL="${SqsQueueUrl}"
            export CONSUL_TAG_KEY="${ConsulEc2RetryJoinTagKey}"
            export CONSUL_TAG_VALUE="${ConsulEc2RetryJoinTagValue}"
            export DEPLOYMENT="${ReadySetDeploymentName}"
            export NORIA_MEMORY_LIMIT_GB="${ReadySetMemoryLimitGB}"
            export NORIA_QUORUM="${ReadySetServerNodes}"
            export NORIA_SHARDS="0"
            export INITIAL_VOLUME_SIZE_GB="${ReadySetServerInitialVolumeSizeGB}"
            export AUTO_GROW_VOLUME="${ReadySetServerAutoGrowVolume}"
            export MAX_VOLUME_SIZE_GB="${ReadySetServerMaxVolumeSizeGB}"
            export LOG_LEVEL="${ReadySetLogLevel}"
            export EXTRA_ENV="${ReadySetServerExtraEnvironment}"
            # Connection Parameters
            export SSM_PATH_DB_PASSWORD=${SSMPathRDSDatabasePassword}
            export USERNAME=${DatabaseAdapterUsername}
            export DB_PROTO=${DatabaseProtocol}
            export DB_HOST=${DatabaseHostname}
            export DB_PORT=${DatabasePort}
            export DB_NAME=${DatabaseName}
            exec /usr/local/bin/user-data-init.sh
            --==BOUNDARY==
          - SqsQueueUrl: !Ref ReadySetServerASGLifecycleTerminateSQS

  ReadySetServerASG:
    CreationPolicy:
      AutoScalingCreationPolicy:
        MinSuccessfulInstancesPercent: 10
      ResourceSignal:
        Count: !Ref ReadySetServerNodes
        Timeout: PT20M
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinSuccessfulInstancesPercent: 10
        MinInstancesInService: 1
        MaxBatchSize: 1
        WaitOnResourceSignals: true
        PauseTime: PT20M
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      LaunchConfigurationName: !Ref ReadySetServerLC
      MaxSize: !Ref ReadySetServerNodes
      MinSize: !Ref ReadySetServerNodes
      VPCZoneIdentifier: !Ref VPCPrivateSubnetIds
      LifecycleHookSpecificationList:
        - LifecycleHookName: ReadySetServerASGTerminateSNS
          LifecycleTransition: autoscaling:EC2_INSTANCE_TERMINATING
          HeartbeatTimeout: 1800
          NotificationTargetARN: !GetAtt ReadySetServerASGLifecycleTerminateSQS.Arn
          RoleARN: !GetAtt ReadySetServerASGRole.Arn
      Tags:
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref AWS::StackName
              - ReadySet-Server
          PropagateAtLaunch: true
        - Key: ReadySet:ServerInstance
          Value: !Ref ReadySetDeploymentName
          PropagateAtLaunch: true

  ReadySetAggregatorCloudWatchLogsManagedPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - logs:CreateLogStream
              - logs:DescribeLogGroups
              - logs:DescribeLogStreams
              - logs:CreateLogGroup
              - logs:PutLogEvents
              - cloudwatch:PutMetricData
            Resource: '*'

Outputs:
  ReadySetAdapterNLBDNSName:
    Description: Host for ReadySet connection string.
    Value: !GetAtt ReadySetPostgreSQLAdapterNLB.DNSName
    Export:
      Name: !Join
        - '-'
        - - !Ref AWS::StackName
          - ReadySetPostgreSQLAdapterNLBDNSName

  ReadySetPostgreSQLVPCEndpointService:
    Description: VPC Endpoint Service to allow connections from outside the VPC.
    Value: !Ref ReadySetPostgreSQLAdapterVPCEndpointService
    Export:
      Name: !Join
        - '-'
        - - !Ref AWS::StackName
          - ReadySetPostgreSQLVPCEndpointService
