AWSTemplateFormatVersion: "2010-09-09"

Description: ReadySet created in a new VPC with a new MySQL RDS instance

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Availability Zone Configuration
        Parameters:
          - AvailabilityZones
      - Label:
          default: VPC Network Configuration
        Parameters:
          - VPCCIDR
          - AdditionalAdapterCIDR
          - VPCCreateNATGateways
          - PublicSubnet1CIDR
          - PublicSubnet2CIDR
          - PublicSubnet3CIDR
          - PrivateSubnet1CIDR
          - PrivateSubnet2CIDR
          - PrivateSubnet3CIDR
          - AdditionalMonitoringCIDR1
      - Label:
          default: SSH Access Configuration
        Parameters:
          - KeyPairName
          - AccessCIDR
      - Label:
          default: Consul Configuration
        Parameters:
          - ConsulEc2RetryJoinTagKey
          - ConsulEc2RetryJoinTagValue
      - Label:
          default: Database Configuration
        Parameters:
          - DatabaseStorageType
          - DatabaseInstanceClass
          - DatabaseAllocatedStorage
          - DatabaseName
          - DatabaseUsername
      - Label:
          default: Secret Configuration
        Parameters:
          - SSMParameterKmsKeyArn
          - SSMPathRDSDatabasePassword
      - Label:
          default: ReadySet Configuration
        Parameters:
          - ReadySetS3BucketName
          - ReadySetS3KeyPrefix
          - ReadySetAdapterInstanceType
          - ReadySetAdapterNodes
          - ReadySetServerInstanceType
          - ReadySetServerNodes
          - ReadySetServerInitialVolumeSizeGB
          - ReadySetServerAutoGrowVolume
          - ReadySetServerMaxVolumeSizeGB
          - ReadySetMonitorInstanceType
          - ReadySetMemoryLimitGB
          - ReadySetDeploymentName
          - ReadySetEnableLogAggregation
          - ReadySetEnableCloudwatch
      - Label:
          default: AWS Quick Start Configuration
        Parameters:
          - QSS3BucketName

Parameters:
  AvailabilityZones:
    Description: 'List of Availability Zones to use for the subnets in the VPC. Note: The logical order is preserved. Requires 3.'
    Type: List<AWS::EC2::AvailabilityZone::Name>

  QSS3BucketName:
    Description: S3 bucket name for the Quick Start assets. Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Type: String
    Default: aws-quickstart
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).

  ReadySetS3BucketName:
    Description: S3 bucket name for the ReadySet assets. ReadySet bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Type: String
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: ReadySet bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).

  ReadySetS3KeyPrefix:
    Description: S3 key prefix for the ReadySet assets. S3 key prefix can include numbers, lowercase letters, uppercase letters, and hyphens (-) and forward slashes (/).
    Type: String
    Default: /readyset/
    AllowedPattern: ^[0-9a-zA-Z-/]*$
    ConstraintDescription: ReadySet S3 key prefix can include numbers, lowercase letters, uppercase letters, and hyphens (-) and forward slashes (/).

  PrivateSubnet1CIDR:
    Description: CIDR block for private subnet 1 located in Availability Zone 1.
    Type: String
    Default: 10.0.0.0/19
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  PrivateSubnet2CIDR:
    Description: CIDR block for private subnet 2 located in Availability Zone 2.
    Type: String
    Default: 10.0.32.0/19
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  PrivateSubnet3CIDR:
    Description: CIDR block for private subnet 3 located in Availability Zone 3.
    Type: String
    Default: 10.0.64.0/19
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  PublicSubnet1CIDR:
    Description: CIDR block for the public DMZ subnet 1 located in Availability Zone 1
    Type: String
    Default: 10.0.128.0/20
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  PublicSubnet2CIDR:
    Description: CIDR block for the public DMZ subnet 2 located in Availability Zone 2
    Type: String
    Default: 10.0.144.0/20
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  PublicSubnet3CIDR:
    Description: CIDR block for the public DMZ subnet 3 located in Availability Zone 3
    Type: String
    Default: 10.0.160.0/20
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  VPCCIDR:
    Description: CIDR block for the VPC
    Type: String
    Default: 10.0.0.0/16
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  AdditionalAdapterCIDR:
    Description: Additional CIDR to allow access to the Adapters from.
    Type: String
    Default: ""
    AllowedPattern: ^|(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  AdditionalMonitoringCIDR1:
    Description: CIDR block for use with monitoring ingress
    Type: String
    Default: ""
    AllowedPattern: ^|(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  VPCCreateNATGateways:
    Description: Set to false when creating only private subnets or when running in airgapped mode.
    Type: String
    AllowedValues:
      - "true"
      - "false"
    Default: "true"

  KeyPairName:
    Description: Public/private key pairs allow you to securely connect to your instance after it launches
    Type: AWS::EC2::KeyPair::KeyName

  AccessCIDR:
    Description: 'The CIDR IP range that is permitted to access this new VPC containing ReadySet resources. Note: a value of 0.0.0.0/0 will allow access from ANY IP address'
    Type: String
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  ConsulEc2RetryJoinTagKey:
    Description: The EC2 instance tag key to filter on when joining to other Consul nodes.
    Type: String
    Default: ReadySetConsulNodeType
    ConstraintDescription: Must match EC2 Tag Name requirements.

  ConsulEc2RetryJoinTagValue:
    Description: The EC2 instance tag value to filter on when joining to other Consul nodes.
    Type: String
    Default: Server
    ConstraintDescription: Must match EC2 Tag Value requirements.

  ReadySetAdapterInstanceType:
    Description: The EC2 instance type to use for adapter instances.
    Type: String
    Default: c5.large

  ReadySetAdapterNodes:
    Description: Number of adapter nodes to create
    Type: String
    Default: 3

  ReadySetServerInstanceType:
    Description: The EC2 instance type to use for server instances.
    Type: String
    Default: c5.large
    AllowedPattern: ^(\w)5.*
    ConstraintDescription: Instance type must be 5th generation.

  ReadySetServerNodes:
    Description: Number of server nodes to create
    Type: String
    Default: 3

  ReadySetMonitorInstanceType:
    Description: The EC2 instance type to use for the logs aggregation instance.
    Type: String
    Default: c5.large

  DatabaseStorageType:
    Description: Database storage type
    Type: String
    Default: gp2

  DatabaseInstanceClass:
    Description: Database instance class
    Type: String
    Default: db.m5.large

  DatabaseAllocatedStorage:
    Description: The size of the database (GiB)
    Type: Number
    Default: 20
    MinValue: 20
    MaxValue: 65536

  DatabaseName:
    Description: Database name
    Type: String
    MinLength: 1
    MaxLength: 64
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: Must be less than 63 characters, begin with a letter, and contain only alphanumeric characters.

  DatabaseUsername:
    Description: Username to log into the MySQL Database
    Type: String
    MinLength: 1
    MaxLength: 16

  ReadySetMemoryLimitGB:
    Description: Memory limit for readyset server instances, in gigabytes. This should generally be set to around 80% of the memory available on the instance. A memory limit of 0 (the default) disables eviction entirely.
    Type: Number
    Default: 0
    MinValue: 0

  ReadySetDeploymentName:
    Type: String
    MinLength: 1
    AllowedPattern: ^[^/ ]+$
    ConstraintDescription: Must be non-empty and cannot contain slashes ("/") or spaces

  ReadySetServerInitialVolumeSizeGB:
    Description: Initial volume size, in gigabytes, to provision for Server instances. This should match the EBS volume size of the RDS instance.
    Type: Number
    Default: 32
    MinValue: 32

  ReadySetServerAutoGrowVolume:
    Description: Automatically grow the volume for the ReadySet server.
    Type: String
    AllowedValues:
      - "true"
      - "false"
    Default: "true"

  ReadySetServerMaxVolumeSizeGB:
    Description: Maximum volume size, in gigabytes, to grow the volume to. If set to zero the volume will have no maximum size. Ignored if ReadySetServerAutoGrowVolume is false.
    Type: Number
    Default: 0

  SSMParameterKmsKeyArn:
    Description: ARN of KMS key that was used to encrypt SSM parameters referenced within this template.
    Type: String

  SSMPathRDSDatabasePassword:
    Description: Path to SSM secure string parameter that contains the backend database password.
    Type: String

  ReadySetEnableCloudwatch:
    Description: Send logs and metrics directly to Cloudwatch
    Type: String
    Default: true

  ReadySetEnableLogAggregation:
    Description: Send logs and metrics to Prometheus
    Type: String
    Default: false

Resources:
  # Base VPC to deploy resources into

  VPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub >-
        https://${QSS3BucketName}.s3.amazonaws.com/quickstart-aws-vpc/templates/aws-vpc.template.yaml
      Parameters:
        AvailabilityZones: !Join
          - ','
          - !Ref AvailabilityZones
        NumberOfAZs: "3"
        PrivateSubnet1ACIDR: !Ref PrivateSubnet1CIDR
        PrivateSubnet2ACIDR: !Ref PrivateSubnet2CIDR
        PrivateSubnet3ACIDR: !Ref PrivateSubnet3CIDR
        PublicSubnet1CIDR: !Ref PublicSubnet1CIDR
        PublicSubnet2CIDR: !Ref PublicSubnet2CIDR
        PublicSubnet3CIDR: !Ref PublicSubnet3CIDR
        VPCCIDR: !Ref VPCCIDR
        CreateNATGateways: !Ref VPCCreateNATGateways

  # Bastion stack for secure access

  BastionStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub >-
        https://${ReadySetS3BucketName}.s3.amazonaws.com${ReadySetS3KeyPrefix}templates/readyset-bastion-template.yaml
      Parameters:
        BastionInstanceType: t3.medium
        KeyPairName: !Ref KeyPairName
        PublicSubnet1ID: !GetAtt VPCStack.Outputs.PublicSubnet1ID
        PublicSubnet2ID: !GetAtt VPCStack.Outputs.PublicSubnet2ID
        RemoteAccessCIDR: !Ref AccessCIDR
        VPCID: !GetAtt VPCStack.Outputs.VPCID

  # Supplemental VPC resources

  VPCSupplementalStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub >-
        https://${ReadySetS3BucketName}.s3.amazonaws.com${ReadySetS3KeyPrefix}templates/readyset-vpc-supplemental-template.yaml
      Parameters:
        VPCPrivateSubnetIds: !Join [',', [!GetAtt VPCStack.Outputs.PrivateSubnet1AID, !GetAtt VPCStack.Outputs.PrivateSubnet2AID, !GetAtt VPCStack.Outputs.PrivateSubnet3AID]]
        VPCID: !GetAtt VPCStack.Outputs.VPCID
        VPCCIDR: !Ref VPCCIDR
        BastionSecurityGroupID: !GetAtt BastionStack.Outputs.BastionSecurityGroupID
        AdditionalAdapterCIDR: !Ref AdditionalAdapterCIDR
        AdditionalMonitoringCIDR1: !Ref AdditionalMonitoringCIDR1

  # Consul Cluster

  ReadySetConsulStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub >-
        https://${ReadySetS3BucketName}.s3.amazonaws.com${ReadySetS3KeyPrefix}templates/readyset-authority-consul-template.yaml
      Parameters:
        KeyPairName: !Ref KeyPairName
        PrivateSubnet1ID: !GetAtt VPCStack.Outputs.PrivateSubnet1AID
        PrivateSubnet2ID: !GetAtt VPCStack.Outputs.PrivateSubnet2AID
        PrivateSubnet3ID: !GetAtt VPCStack.Outputs.PrivateSubnet3AID
        ConsulEc2RetryJoinTagKey: !Ref ConsulEc2RetryJoinTagKey
        ConsulEc2RetryJoinTagValue: !Ref ConsulEc2RetryJoinTagValue
        # Security Groups
        ConsulServerSecurityGroupID: !GetAtt VPCSupplementalStack.Outputs.ConsulServerSecurityGroupID

  # RDS MySQL Cluster

  ReadySetRDSMySQLStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub >-
        https://${ReadySetS3BucketName}.s3.amazonaws.com${ReadySetS3KeyPrefix}templates/readyset-rds-mysql-template.yaml
      Parameters:
        PrivateSubnet1ID: !GetAtt VPCStack.Outputs.PrivateSubnet1AID
        PrivateSubnet2ID: !GetAtt VPCStack.Outputs.PrivateSubnet2AID
        PrivateSubnet3ID: !GetAtt VPCStack.Outputs.PrivateSubnet3AID
        VPCID: !GetAtt VPCStack.Outputs.VPCID
        VPCCIDR: !Ref VPCCIDR
        DatabaseStorageType: !Ref DatabaseStorageType
        DatabaseInstanceClass: !Ref DatabaseInstanceClass
        DatabaseAllocatedStorage: !Ref DatabaseAllocatedStorage
        DatabaseUsername: !Ref DatabaseUsername
        DatabaseName: !Ref DatabaseName
        SSMPathRDSDatabasePassword: !Ref SSMPathRDSDatabasePassword

  # ReadySet Monitoring Stack

  ReadySetMonitoringStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub >-
        https://${ReadySetS3BucketName}.s3.amazonaws.com${ReadySetS3KeyPrefix}templates/readyset-monitoring-template.yaml
      Parameters:
        ReadySetMonitorInstanceType: !Ref ReadySetMonitorInstanceType
        ReadySetMonitoringSecurityGroupID: !GetAtt VPCSupplementalStack.Outputs.ReadySetMonitoringSecurityGroupID
        PrivateSubnet1ID: !GetAtt VPCStack.Outputs.PrivateSubnet1AID
        KeyPairName: !Ref KeyPairName
        ConsulEc2RetryJoinTagKey: !GetAtt ReadySetConsulStack.Outputs.ConsulEc2RetryJoinTagKey
        ConsulEc2RetryJoinTagValue: !GetAtt ReadySetConsulStack.Outputs.ConsulEc2RetryJoinTagValue
        ReadySetDeploymentName: !Ref ReadySetDeploymentName
        ConsulJoinManagedPolicyArn: !GetAtt ReadySetConsulStack.Outputs.ConsulJoinManagedPolicyArn

  # ReadySet for MySQL

  ReadySetMySQLStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: ReadySetMonitoringStack
    Properties:
      TemplateURL: !Sub >-
        https://${ReadySetS3BucketName}.s3.amazonaws.com${ReadySetS3KeyPrefix}templates/readyset-mysql-template.yaml
      Parameters:
        ConsulJoinManagedPolicyArn: !GetAtt ReadySetConsulStack.Outputs.ConsulJoinManagedPolicyArn
        PrivateSubnet1ID: !GetAtt VPCStack.Outputs.PrivateSubnet1AID
        PrivateSubnet2ID: !GetAtt VPCStack.Outputs.PrivateSubnet2AID
        PrivateSubnet3ID: !GetAtt VPCStack.Outputs.PrivateSubnet3AID
        VPCID: !GetAtt VPCStack.Outputs.VPCID
        ConsulEc2RetryJoinTagKey: !GetAtt ReadySetConsulStack.Outputs.ConsulEc2RetryJoinTagKey
        ConsulEc2RetryJoinTagValue: !GetAtt ReadySetConsulStack.Outputs.ConsulEc2RetryJoinTagValue
        KeyPairName: !Ref KeyPairName
        ReadySetAdapterInstanceType: !Ref ReadySetAdapterInstanceType
        ReadySetAdapterNodes: !Ref ReadySetAdapterNodes
        ReadySetServerInstanceType: !Ref ReadySetServerInstanceType
        ReadySetServerNodes: !Ref ReadySetServerNodes
        ReadySetServerInitialVolumeSizeGB: !Ref ReadySetServerInitialVolumeSizeGB
        ReadySetServerAutoGrowVolume: !Ref ReadySetServerAutoGrowVolume
        ReadySetServerMaxVolumeSizeGB: !Ref ReadySetServerMaxVolumeSizeGB
        ReadySetMemoryLimitGB: !Ref ReadySetMemoryLimitGB
        ReadySetDeploymentName: !Ref ReadySetDeploymentName
        # Networking Inputs
        ReadySetServerSecurityGroupID: !GetAtt VPCSupplementalStack.Outputs.ReadySetServerSecurityGroupID
        ReadySetAdapterSecurityGroupID: !GetAtt VPCSupplementalStack.Outputs.ReadySetAdapterSecurityGroupID
        # Backend DB Inputs
        SSMParameterKmsKeyArn: !Ref SSMParameterKmsKeyArn
        SSMPathRDSDatabasePassword: !Ref SSMPathRDSDatabasePassword
        DatabaseName: !Ref DatabaseName
        DatabaseHostname: !GetAtt ReadySetRDSMySQLStack.Outputs.DatabaseHostname
        DatabaseAdapterUsername: !Ref DatabaseUsername
        DatabasePort: !GetAtt ReadySetRDSMySQLStack.Outputs.DatabasePort
        # Logging
        EnableAggregation: !Ref ReadySetEnableLogAggregation
        EnableCloudwatch: !Ref ReadySetEnableCloudwatch

Outputs:
  ReadySetMySQLVPCEndpointService:
    Description: S3 VPC Endpoint to connect to to access ReadySet.
    Value: !GetAtt ReadySetMySQLStack.Outputs.ReadySetMySQLVPCEndpointService

  ReadySetServerSecurityGroupID:
    Description: ID of VPC security group designated for ReadySet Server instances.
    Value: !GetAtt VPCSupplementalStack.Outputs.ReadySetServerSecurityGroupID

  ReadySetAdapterSecurityGroupID:
    Description: ID of VPC security group designated for ReadySet Adapter instances.
    Value: !GetAtt VPCSupplementalStack.Outputs.ReadySetAdapterSecurityGroupID

  ReadySetMonitoringSecurityGroupID:
    Description: ID of VPC security group designated for ReadySet Monitoring instance(s).
    Value: !GetAtt VPCSupplementalStack.Outputs.ReadySetMonitoringSecurityGroupID

  ReadySetDBSecurityGroup:
    Description: Attach this Security Group to your RDS instance.
    Value: !GetAtt VPCSupplementalStack.Outputs.ReadySetDBSecurityGroupID

  BastionHostEIP1:
    Description: Elastic IP bound to Bastion host 1.
    Value: !GetAtt BastionStack.Outputs.EIP1

  ReadySetRDSHost:
    Description: Hostname of the RDS database.
    Value: !GetAtt ReadySetRDSMySQLStack.Outputs.DatabaseHostname

  ReadySetMonitorLANIP:
    Description: VPC IP of monitor instance.
    Value: !GetAtt ReadySetMonitoringStack.Outputs.ReadySetMonitorInstanceLANIP

  ReadySetAdapterNLBDNSName:
    Description: Host for ReadySet connection string.
    Value: !GetAtt ReadySetMySQLStack.Outputs.ReadySetAdapterNLBDNSName

  ReadySetMySQLAdapterTargetGroupARN:
    Description: ARN of the MySQL Adapter Target Group.
    Value: !GetAtt ReadySetMySQLStack.Outputs.ReadySetMySQLAdapterTargetGroupARN
