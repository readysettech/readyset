AWSTemplateFormatVersion: "2010-09-09"

Description: Creates an IAM user for deploying ReadySet

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Authentication Parameters
        Parameters:
          - InitialPassword

Parameters:
  InitialPassword:
    Description: Initial password for ReadySet user
    Type: String
    Default: R3adyS3t!
    MinLength: 8
    NoEcho: true
    ConstraintDescription: Must follow your IAM user password policy

Resources:
  ReadySetCloudFormationExecutionRolePolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Policy ReadySet CloudFormation will deploy with
      Path: /
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - autoscaling:CreateAutoScalingGroup
              - autoscaling:CreateLaunchConfiguration
              - autoscaling:DeleteAutoScalingGroup
              - autoscaling:DeleteLaunchConfiguration
              - autoscaling:DescribeAutoScalingGroups
              - autoscaling:DescribeAutoScalingInstances
              - autoscaling:DescribeLaunchConfigurations
              - autoscaling:DescribeScalingActivities
              - autoscaling:UpdateAutoScalingGroup
              - ec2:AllocateAddress
              - ec2:AssociateDhcpOptions
              - ec2:AssociateRouteTable
              - ec2:AttachInternetGateway
              - ec2:AuthorizeSecurityGroupEgress
              - ec2:AuthorizeSecurityGroupIngress
              - ec2:CreateDhcpOptions
              - ec2:CreateInternetGateway
              - ec2:CreateNatGateway
              - ec2:CreateRoute
              - ec2:CreateRouteTable
              - ec2:CreateSecurityGroup
              - ec2:CreateSubnet
              - ec2:CreateTags
              - ec2:CreateVpc
              - ec2:CreateVpcEndpoint
              - ec2:CreateVpcEndpointServiceConfiguration
              - ec2:DeleteDhcpOptions
              - ec2:DeleteInternetGateway
              - ec2:DeleteNatGateway
              - ec2:DeleteRoute
              - ec2:DeleteRouteTable
              - ec2:DeleteSecurityGroup
              - ec2:DeleteSubnet
              - ec2:DeleteVpc
              - ec2:DeleteVpcEndpointServiceConfigurations
              - ec2:DeleteVpcEndpoints
              - ec2:Describe*
              - ec2:DetachInternetGateway
              - ec2:DisassociateRouteTable
              - ec2:ModifySubnetAttribute
              - ec2:ModifyVpcAttribute
              - ec2:ReleaseAddress
              - ec2:RevokeSecurityGroupEgress
              - ec2:RevokeSecurityGroupIngress
              - ec2:RunInstances
              - ec2:TerminateInstances
              - elasticloadbalancing:AddTags
              - elasticloadbalancing:CreateListener
              - elasticloadbalancing:CreateLoadBalancer
              - elasticloadbalancing:CreateTargetGroup
              - elasticloadbalancing:DeleteListener
              - elasticloadbalancing:DeleteLoadBalancer
              - elasticloadbalancing:DeleteTargetGroup
              - elasticloadbalancing:DescribeListeners
              - elasticloadbalancing:DescribeLoadBalancers
              - elasticloadbalancing:DescribeTargetGroups
              - iam:AddRoleToInstanceProfile
              - iam:AttachRolePolicy
              - iam:AttachUserPolicy
              - iam:CreateInstanceProfile
              - iam:CreateLoginProfile
              - iam:CreatePolicy
              - iam:CreateRole
              - iam:CreateServiceLinkedRole
              - iam:CreateUser
              - iam:DeleteInstanceProfile
              - iam:DeleteLoginProfile
              - iam:DeletePolicy
              - iam:DeleteRole
              - iam:DeleteRolePolicy
              - iam:DeleteUser
              - iam:DetachRolePolicy
              - iam:DetachUserPolicy
              - iam:GetPolicy
              - iam:GetRole
              - iam:GetRolePolicy
              - iam:ListAccessKeys
              - iam:ListPolicyVersions
              - iam:PassRole
              - iam:PutRolePolicy
              - iam:RemoveRoleFromInstanceProfile
              - logs:CreateLogGroup
              - logs:DeleteLogGroup
              - logs:DeleteMetricFilter
              - logs:PutMetricFilter
              - rds:CreateDBInstance
              - rds:CreateDBParameterGroup
              - rds:CreateDBSubnetGroup
              - rds:DescribeDBInstance
              - rds:DescribeDBSubnetGroups
              - rds:DescribeEngineDefaultParameters
              - rds:DeleteDBInstance
              - rds:DeleteDBParameterGroup
              - rds:DeleteDBSubnetGroup
              - rds:ModifyDBParameterGroup
              - rds:ModifyDBSubnetGroup
              - rds:DescribeEngineDefaultParameters
              - s3:GetObject
              - s3:ListBucket
              - sqs:CreateQueue
              - sqs:DeleteQueue
              - sqs:GetQueueAttributes
              - ssm:GetParameter
              - ssm:GetParameters
            Resource: '*'

  ReadySetCloudFormationExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Ref ReadySetCloudFormationExecutionRolePolicy

  ReadySetDeployPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Policy for allowing ReadySet to deploy
      Path: /
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - cloudformation:CreateStack
              - cloudformation:CreateChangeSet
              - cloudformation:DeleteStack
              - cloudformation:DeleteChangeSet
              - cloudformation:UpdateStack
            Resource: '*'

  ReadySetUser:
    Type: AWS::IAM::User
    Properties:
      LoginProfile:
        Password: !Ref InitialPassword
        PasswordResetRequired: true
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AWSCloudFormationReadOnlyAccess
        - arn:aws:iam::aws:policy/AutoScalingConsoleReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/IAMReadOnlyAccess
        - arn:aws:iam::aws:policy/IAMUserChangePassword
        - !Ref ReadySetDeployPolicy
      Policies:
        - PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: iam:PassRole
                Resource:
                  - !GetAtt ReadySetCloudFormationExecutionRole.Arn
              - Effect: Allow
                Action:
                  - iam:CreateAccessKey
                  - iam:DeleteAccessKey
                  - iam:ListAccessKeys
                  - iam:UpdateAccessKey
                Resource: arn:aws:iam::*:user/${aws:username}
          PolicyName: ReadySetCloudFormationPassRole
