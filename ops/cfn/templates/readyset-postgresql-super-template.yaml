AWSTemplateFormatVersion: "2010-09-09"

Description: ReadySet created in a new VPC with a new RDS PostgreSQL database

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: VPC Network Configuration
        Parameters:
          - VPCCIDR
          - PublicSubnet1CIDR
          - PublicSubnet2CIDR
          - PublicSubnet3CIDR
          - PrivateSubnet1CIDR
          - PrivateSubnet2CIDR
          - PrivateSubnet3CIDR
          - AvailabilityZones
      - Label:
          default: SSH Access Configuration
        Parameters:
          - KeyPairName
          - AccessCIDR
      - Label:
          default: Consul Configuration
        Parameters:
          - ConsulEc2RetryJoinTagKey
          - ConsulEc2RetryJoinTagValue
      - Label:
          default: Database Configuration
        Parameters:
          - DatabaseStorageType
          - DatabaseInstanceClass
          - DatabaseAllocatedStorage
          - DatabaseName
          - DatabaseUsername
          - DatabasePassword
      - Label:
          default: ReadySet Configuration
        Parameters:
          - ReadySetS3BucketName
          - ReadySetAdapterInstanceType
          - ReadySetAdapterNodes
          - ReadySetServerInstanceType
          - ReadySetServerNodes
          - ReadySetServerVolumeSizeGB
          - ReadySetMonitorInstanceType
          - ReadySetMemoryLimitGB
          - ReadySetDeploymentName
      - Label:
          default: AWS Quick Start Configuration
        Parameters:
          - QSS3BucketName

Parameters:
  AvailabilityZones:
    Description: 'List of Availability Zones to use for the subnets in the VPC. Note: The logical order is preserved. Requires 3.'
    Type: List<AWS::EC2::AvailabilityZone::Name>

  QSS3BucketName:
    Description: S3 bucket name for the Quick Start assets. Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Type: String
    Default: aws-quickstart
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).

  ReadySetS3BucketName:
    # Default: tbd
    Description: S3 bucket name for the ReadySet assets. ReadySet bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Type: String
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: ReadySet bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).

  PrivateSubnet1CIDR:
    Description: Please enter the IP range (CIDR notation) for the private subnet in the first Availability Zone
    Type: String
    Default: 10.0.0.0/19
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  PrivateSubnet2CIDR:
    Description: Please enter the IP range (CIDR notation) for the private subnet in the second Availability Zone
    Type: String
    Default: 10.0.32.0/19
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  PrivateSubnet3CIDR:
    Description: Please enter the IP range (CIDR notation) for the private subnet in the third Availability Zone
    Type: String
    Default: 10.0.64.0/19
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  PublicSubnet1CIDR:
    Description: Please enter the IP range (CIDR notation) for the public subnet in the first Availability Zone
    Type: String
    Default: 10.0.128.0/20
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  PublicSubnet2CIDR:
    Description: Please enter the IP range (CIDR notation) for the public subnet in the second Availability Zone
    Type: String
    Default: 10.0.144.0/20
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  PublicSubnet3CIDR:
    Description: Please enter the IP range (CIDR notation) for the public subnet in the third Availability Zone
    Type: String
    Default: 10.0.160.0/20
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  VPCCIDR:
    Description: Please enter the IP range (CIDR notation) for this VPC
    Type: String
    Default: 10.0.0.0/16
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  KeyPairName:
    Description: Public/private key pairs allow you to securely connect to your instance after it launches
    Type: AWS::EC2::KeyPair::KeyName

  AccessCIDR:
    Description: 'The CIDR IP range that is permitted to access this new VPC containing ReadySet resources. Note: a value of 0.0.0.0/0 will allow access from ANY IP address'
    Type: String
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  ConsulEc2RetryJoinTagKey:
    Description: The EC2 instance tag key to filter on when joining to other Consul nodes.
    Type: String
    Default: ReadySetConsulNodeType
    ConstraintDescription: Must match EC2 Tag Name requirements.

  ConsulEc2RetryJoinTagValue:
    Description: The EC2 instance tag value to filter on when joining to other Consul nodes.
    Type: String
    Default: Server
    ConstraintDescription: Must match EC2 Tag Value requirements.

  ReadySetAdapterInstanceType:
    Description: The EC2 instance type to use for the ReadySet adapter instances.
    Type: String
    Default: c5.large
    AllowedPattern: ^(\w)5.*
    ConstraintDescription: Instance type must be 5th generation

  ReadySetAdapterNodes:
    Description: Number of adapter nodes to create
    Type: String
    Default: 3

  ReadySetServerInstanceType:
    Description: The EC2 instance type to use for ReadySet server instances.
    Type: String
    Default: c5.large
    AllowedPattern: ^(\w)5.*
    ConstraintDescription: Instance type must be 5th generation.

  ReadySetServerNodes:
    Description: Number of server nodes to create
    Type: String
    Default: 3

  ReadySetMonitorInstanceType:
    Description: The EC2 instance type to use for the logs aggregation instance.
    Type: String
    Default: c5.large

  DatabaseStorageType:
    Description: Database storage type
    Type: String
    Default: gp2

  DatabaseInstanceClass:
    Description: Database instance class
    Type: String
    Default: db.t3.medium

  DatabaseAllocatedStorage:
    Description: The size of the database (GiB)
    Type: Number
    Default: 20
    MinValue: 20
    MaxValue: 65536

  DatabaseName:
    Description: Database name
    Type: String
    MinLength: 1
    MaxLength: 64
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: Must begin with a letter and contain only alphanumeric characters.

  DatabaseUsername:
    Description: Username to log into the PostgreSQL Database
    Type: String
    MinLength: 1
    MaxLength: 16

  DatabasePassword:
    Description: Password to log into the PostgreSQL Database
    Type: String
    NoEcho: true
    MinLength: 8
    MaxLength: 41

  ReadySetMemoryLimitGB:
    Description: Memory limit for readyset server instances, in gigabytes. This should generally be set to around 80% of the memory available on the instance. A memory limit of 0 (the default) disables eviction entirely.
    Type: Number
    Default: 0
    MinValue: 0

  ReadySetDeploymentName:
    Type: String
    MinLength: 1
    AllowedPattern: ^[^/ ]+$
    ConstraintDescription: Must be non-empty and cannot contain slashes ("/") or spaces

  ReadySetServerVolumeSizeGB:
    Description: Volume size, in gigabytes, to provision for Server instances.
    Type: Number
    Default: 32
    MinValue: 32

Resources:
  VPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub >-
        https://${QSS3BucketName}.s3.amazonaws.com/quickstart-aws-vpc/templates/aws-vpc.template.yaml
      Parameters:
        AvailabilityZones: !Join
          - ','
          - !Ref AvailabilityZones
        NumberOfAZs: "3"
        PrivateSubnet1ACIDR: !Ref PrivateSubnet1CIDR
        PrivateSubnet2ACIDR: !Ref PrivateSubnet2CIDR
        PrivateSubnet3ACIDR: !Ref PrivateSubnet3CIDR
        PublicSubnet1CIDR: !Ref PublicSubnet1CIDR
        PublicSubnet2CIDR: !Ref PublicSubnet2CIDR
        PublicSubnet3CIDR: !Ref PublicSubnet3CIDR
        VPCCIDR: !Ref VPCCIDR

  BastionStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub >-
        https://${QSS3BucketName}.s3.amazonaws.com/quickstart-linux-bastion/templates/linux-bastion.template
      Parameters:
        BastionAMIOS: Ubuntu-Server-20.04-LTS-HVM
        BastionInstanceType: t3.medium
        KeyPairName: !Ref KeyPairName
        PublicSubnet1ID: !GetAtt VPCStack.Outputs.PublicSubnet1ID
        PublicSubnet2ID: !GetAtt VPCStack.Outputs.PublicSubnet2ID
        RemoteAccessCIDR: !Ref AccessCIDR
        VPCID: !GetAtt VPCStack.Outputs.VPCID
        EnableTCPForwarding: true

  ReadySetConsulStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub >-
        https://${ReadySetS3BucketName}.s3.amazonaws.com/readyset/templates/readyset-authority-consul-template.yaml
      Parameters:
        BastionSecurityGroupID: !GetAtt BastionStack.Outputs.BastionSecurityGroupID
        KeyPairName: !Ref KeyPairName
        PrivateSubnet1ID: !GetAtt VPCStack.Outputs.PrivateSubnet1AID
        PrivateSubnet2ID: !GetAtt VPCStack.Outputs.PrivateSubnet2AID
        PrivateSubnet3ID: !GetAtt VPCStack.Outputs.PrivateSubnet3AID
        VPCID: !GetAtt VPCStack.Outputs.VPCID
        VPCCIDR: !Ref VPCCIDR
        ConsulEc2RetryJoinTagKey: !Ref ConsulEc2RetryJoinTagKey
        ConsulEc2RetryJoinTagValue: !Ref ConsulEc2RetryJoinTagValue

  ReadySetRDSPostgreSQLStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub >-
        https://${ReadySetS3BucketName}.s3.amazonaws.com/readyset/templates/readyset-rds-postgresql-template.yaml
      Parameters:
        VPCPrivateSubnetIds: !Join [',', [!GetAtt VPCStack.Outputs.PrivateSubnet1AID, !GetAtt VPCStack.Outputs.PrivateSubnet2AID, !GetAtt VPCStack.Outputs.PrivateSubnet3AID]]
        VPCID: !GetAtt VPCStack.Outputs.VPCID
        VPCCIDR: !Ref VPCCIDR
        DatabaseStorageType: !Ref DatabaseStorageType
        DatabaseInstanceClass: !Ref DatabaseInstanceClass
        DatabaseAllocatedStorage: !Ref DatabaseAllocatedStorage
        DatabaseName: !Ref DatabaseName
        DatabaseUsername: !Ref DatabaseUsername
        DatabasePassword: !Ref DatabasePassword

  ReadySetPostgreSQLStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub >-
        https://${ReadySetS3BucketName}.s3.amazonaws.com/readyset/templates/readyset-postgresql-template.yaml
      Parameters:
        BastionSecurityGroupID: !GetAtt BastionStack.Outputs.BastionSecurityGroupID
        ConsulJoinManagedPolicyArn: !GetAtt ReadySetConsulStack.Outputs.ConsulJoinManagedPolicyArn
        VPCPrivateSubnetIds: !Join [',', [!GetAtt VPCStack.Outputs.PrivateSubnet1AID, !GetAtt VPCStack.Outputs.PrivateSubnet2AID, !GetAtt VPCStack.Outputs.PrivateSubnet3AID]]
        VPCID: !GetAtt VPCStack.Outputs.VPCID
        VPCCIDR: !Ref VPCCIDR
        ConsulEc2RetryJoinTagKey: !GetAtt ReadySetConsulStack.Outputs.ConsulEc2RetryJoinTagKey
        ConsulEc2RetryJoinTagValue: !GetAtt ReadySetConsulStack.Outputs.ConsulEc2RetryJoinTagValue
        KeyPairName: !Ref KeyPairName
        PostgresDatabaseURL: !GetAtt ReadySetRDSPostgreSQLStack.Outputs.DatabaseURL
        ReadySetAdapterInstanceType: !Ref ReadySetAdapterInstanceType
        ReadySetAdapterNodes: !Ref ReadySetAdapterNodes
        ReadySetServerInstanceType: !Ref ReadySetServerInstanceType
        ReadySetServerNodes: !Ref ReadySetServerNodes
        ReadySetServerVolumeSizeGB: !Ref ReadySetServerVolumeSizeGB
        ReadySetMonitorInstanceType: !Ref ReadySetMonitorInstanceType
        ReadySetMemoryLimitGB: !Ref ReadySetMemoryLimitGB
        ReadySetDeploymentName: !Ref ReadySetDeploymentName

Outputs:
  ReadySetPostgreSQLVPCEndpointService:
    Description: VPC Endpoint to connect to to access ReadySet
    Value: !GetAtt ReadySetPostgreSQLStack.Outputs.ReadySetPostgreSQLVPCEndpointService
