
steps:
  {{#each root_modules}}
  - label: ":terraform: Validate for {{ path }}"
    plugins:
      - docker#v3.8.0:
          image: "305232526136.dkr.ecr.us-east-2.amazonaws.com/substrate-runtime:${BUILDKITE_COMMIT}"
          propagate-environment: true
          propagate-aws-auth-tokens: true
          shell: false
          command:
            - "buildkite-terraform-validate"
            - "{{ path }}"
          environment:
          - BUILDKITE_API_TOKEN
      - ecr#v2.2.0:
          account_ids: "305232526136"
          login: true
      - cultureamp/aws-assume-role#v0.2.0:
          role: "arn:aws:iam::716876017850:role/Administrator"
    agents:
      queue: ops
  {{/each}}

  - wait

  {{#if plan_only}}
  - label: ":pipeline: Upload plan all pipeline"
    command: buildkite-terraform-upload-plan-all-pipeline
    plugins:
      - docker#v3.8.0:
          image: "305232526136.dkr.ecr.us-east-2.amazonaws.com/substrate-runtime:${BUILDKITE_COMMIT}"
          propagate-environment: true
          propagate-aws-auth-tokens: true
          shell: false
      - ecr#v2.2.0:
          login: true
      - cultureamp/aws-assume-role#v0.2.0:
          role: "arn:aws:iam::716876017850:role/Administrator"
    agents:
      queue: ops
  {{else}}
  # - label: ":pipeline: Upload plan and apply pipeline"
  #   commands:
  #     - buildkite-terraform-upload-plan-and-apply-pipeline
  #   plugins:
  #     - docker#v3.8.0:
  #         image: "305232526136.dkr.ecr.us-east-2.amazonaws.com/substrate-runtime:${BUILDKITE_COMMIT}"
  #         propagate-environment: true
  #         shell: false
  #     - ecr#v2.2.0:
  #         login: true
  {{/if}}
