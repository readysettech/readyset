# ReadySet Development Environment

## What is this?

A guide to setting up a development environment for ReadySet.

### Project Layout

```text
├── http # Ubuntu 2x.xx autoinstall files
│   ├── meta-data # Empty but required for builds
│   └── user-data # Describes machine state of canonical reference image
├── README.md # This file
└── ubuntu-20.04-uefi.pkr.hcl # Canonical reference image build steps 
```

### Considerations

ReadySet development environments need to be [SOC 2](https://www.imperva.com/learn/data-security/soc-2-compliance/)
compliant and there are required development and communication tools in order to work with ReadySet code.

### Required Packages

#### General Tools

The following tools will be useful for _all_ engineers.

| Package | Use |
|---------|-----|
| Slack | Canonical communication platform |
| Git | Code repository management |
| Tailscale | VPN client |
| rustup | Rust version manager |
| A browser (Firefox, Chrome, etc.) | Access G Suite utilities |
| Zoom | Most common means to host meetings (G Suite is also used) |

#### DevOps and Provisioning Tools

These packages may or may not be useful for general engineers but should be
installed for DevOps engineers.

| Package | Use |
|---------|-----|
| docker | Used for parts of the CI/CD pipeline and elsewhere |
| docker-compose | Occasionally used for internal infrastructure |
| Terraform | Provisioning internal infrastructure |
| Packer | Building AMIs and other machine images |

#### Common "Gotchas"

* All storage devices containing ReadySet code must be _at rest_ encrypted.
* SSH keys must be encrypted (via `ssh-keygen -t ed25519 -C <user name>-<RFC 3339 date>@readyset.io` or similar and included a password).

## Canonical Development Environment

This repo contains provisioning files for a canonical development environment to demonstrate
the core features any dev environment will need.
The canonical environment is an Ubuntu 20.04 QEMU image that can be used as a VM or used
to provision a bare metal machine. This image uses a UEFI partitioning scheme
and full disk encryption via `dm-crypt` in order to meet certain SOC 2 _in situ_ encryption requirements.
Further the image installs all required development and communication tools during installation.

### Pre-Reqs

The following packages will need to be installed in order to build a canonical development environment image
locally.

* packer
* KVM / QEMU

### Building an Image

`packer build ./ubuntu-20.04-uefi.pkr.hcl -var "output_directory=<directory for generated image>"`

Note `ubuntu-20.04-uefi.pkr.hcl` defines many more configuration variables than `output_directory` which
may or may not be useful to set.

### System Variables

| Variable     | Default      |
|--------------|--------------|
| Host Name    | readyset-dev |
| User Name    | readyset     |
| Password     | change       |
| DM Crypt Key | change       |

* Note these variables are all set within `./http/user-data`
* Password _must_ be in crypted format which can be accomplished via 
`printf '<password>' | openssl passwd -6 -salt 'FhcddHFVZ7ABA4Gi' -stdin` or similar

### Copying to Physical Media

The raw disk image generated by packer can either be run as a QEMU virtual machine or copied onto
physical media to run on a bare metal system.

Since we're working with raw disk images we copy the entire generated disk over using a command like `dd`:
```shell
dd if=/<path to disk image>/canonical_readyset_dev of=/dev/sd<X> bs=4k
```

Where `sd<X>` corresponds to the dev file for a physical device like a hard drive, USB stick etc.

As with anything involving `dd` be _extremely cautious_ about identifying the correct dev file before running the command.

Further once the disk image is copied over you'll need to re-size the root partition in order to fill the physical media completely.

### Further Reading

Ubuntu 2x.xx autoinstall is fairly opaque; below are some resources to reference:

* [Ubuntu autoinstall quick start](https://ubuntu.com/server/docs/install/autoinstall-quickstart)
* [Github project showing packer templates for Ubuntu 18.xx and 2x.xx](https://github.com/tylert/packer-build/tree/master/source/ubuntu)

## Things to do after installation

* Login to G Suite with ReadySet credentials
* Login to Slack
* Download Kolide via the Slack bot prompts (accessed via Apps => Kolide)
* Run Tailscale with root privileges via `tailscale up --accept-dns`
  * Tailscale _must_ be up in order to access Gerrit
* Set a username in Gerrit, which is _required_ to pull the Mono Repo or submit change lists
* Generate an encrypted SSH key if you haven't already and copy it into Gerrit
  * The ReadySet Mono Repo is located at `https://gerrit.readyset.name` or `https://gerrit` if Tailscale is up
* Clone ReadySet mono repo and download Gerrit pre-commit hooks
* Install [RustUp](https://rustup.rs/)