steps:
  - label: ":docker: Build Rust Build Image"
    key: build-rust-build-image
    commands:
      - "echo --- :docker: Building build image"
      - >-
        docker build \
          -f Dockerfile.build \
          --cache-from 305232526136.dkr.ecr.us-east-2.amazonaws.com/substrate-runtime:build \
          -t 305232526136.dkr.ecr.us-east-2.amazonaws.com/substrate-runtime:build \
          .
      - "echo --- :docker: Pushing build image"
      - "docker image push 305232526136.dkr.ecr.us-east-2.amazonaws.com/substrate-runtime:build"
    plugins:
      ecr#v2.2.0:
        login: true

  - label: ":rust: Check rustfmt"
    key: check-rustfmt
    commands:
      - "cargo --locked fmt -- --check"
    depends_on:
      - build-rust-build-image
    plugins:
      - docker#v3.7.0:
          image: "305232526136.dkr.ecr.us-east-2.amazonaws.com/substrate-runtime:build"
          environment:
            - "CARGO_INCREMENTAL=0"
      - ecr#v2.2.0:
          login: true

  - label: ":rust: :clippy: Check clippy"
    key: check-clippy
    commands:
      - cargo --locked clippy --all -- -D warnings
    depends_on:
      - build-rust-build-image
    plugins:
      - docker#v3.7.0:
          image: "305232526136.dkr.ecr.us-east-2.amazonaws.com/substrate-runtime:build"
          environment:
            - "CARGO_INCREMENTAL=0"
      - ecr#v2.2.0:
          login: true

  - label: ":rust: Run tests"
    key: run-tests
    commands:
      - "echo --- :rust: Build tests"
      - cargo test --no-run --locked
      - "echo --- :rust: Run tests"
      - cargo test
    depends_on:
      - build-rust-build-image
    plugins:
      - docker#v3.7.0:
          image: "305232526136.dkr.ecr.us-east-2.amazonaws.com/substrate-runtime:build"
          environment:
            - "CARGO_INCREMENTAL=0"
      - ecr#v2.2.0:
          login: true

  - label: ":rust: :docker: Build Substrate Runtime Image"
    key: build-runtime-image
    commands:
      - "echo --- :docker: Building image"
      - >-
        DOCKER_BUILDKIT=1 docker build \
          --cache-from 305232526136.dkr.ecr.us-east-2.amazonaws.com/substrate-runtime:latest \
          -t 305232526136.dkr.ecr.us-east-2.amazonaws.com/substrate-runtime:${BUILDKITE_COMMIT} \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          .
      - "echo --- :docker: Add latest tag for caching"
      - >-
        docker image tag 305232526136.dkr.ecr.us-east-2.amazonaws.com/substrate-runtime:${BUILDKITE_COMMIT} \
          305232526136.dkr.ecr.us-east-2.amazonaws.com/substrate-runtime:latest
      - "echo --- :docker: Pushing image"
      - "docker image push --all-tags 305232526136.dkr.ecr.us-east-2.amazonaws.com/substrate-runtime"
    depends_on:
      - check-rustfmt
      - check-clippy
      - run-tests
    plugins:
      - ecr#v2.2.0:
          login: true

  - label: ":pipeline: Upload Validate All Pipeline"
    commands:
      - buildkite-terraform-upload-validate-all-pipeline
    depends_on:
      - build-runtime-image
    plugins:
      - docker#v3.7.0:
          image: "305232526136.dkr.ecr.us-east-2.amazonaws.com/substrate-runtime:${BUILDKITE_COMMIT}"
          shell: false
          propagate-environment: true
      - ecr#v2.2.0:
          login: true
