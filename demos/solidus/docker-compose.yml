version: "3.8"
services:
  consul:
    image: 305232526136.dkr.ecr.us-east-2.amazonaws.com/mirror/consul
    healthcheck:
      test: ["CMD", "nc", "-vz", "localhost", "8500"]
      interval: 10s
      timeout: 2s
      retries: 5
      start_period: 5s
  mysql:
    image: 305232526136.dkr.ecr.us-east-2.amazonaws.com/mirror/mysql:8.0
    expose:
      - 3306
    environment:
      MYSQL_DATABASE: solidus
      MYSQL_ROOT_PASSWORD: noria
    depends_on:
      consul:
        condition: service_healthy
    healthcheck:
      test: "mysqladmin ping"
      start_period: 10s
      interval: 10s
      timeout: 2s
      retries: 5
  readyset-server:
    image: "305232526136.dkr.ecr.us-east-2.amazonaws.com/readyset-server:0627dab2f9e6b1043e376f75a0df6ef1e9234835"
    expose:
      - "32768-60999"
    environment:
      AUTHORITY_ADDRESS: consul:8500
      AUTHORITY: "consul"
      LISTEN_ADDRESS: 0.0.0.0
      EXTERNAL_ADDRESS: readyset-server
      NORIA_DEPLOYMENT: solidus
      REPLICATION_URL: mysql://root:noria@mysql/solidus
      PROMETHEUS_METRICS: 1
      FORBID_FULL_MATERIALIZATION: 1
    links:
      - mysql
      - consul
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "127.0.0.1:6033/prometheus"]
      interval: 10s
      timeout: 2s
      retries: 5
      start_period: 5s
  db:
    image: "305232526136.dkr.ecr.us-east-2.amazonaws.com/readyset-mysql:0627dab2f9e6b1043e376f75a0df6ef1e9234835"
    expose:
      - 3306
    environment:
      AUTHORITY_ADDRESS: consul:8500
      AUTHORITY: "consul"
      LISTEN_ADDRESS: 0.0.0.0:3306
      NORIA_DEPLOYMENT: solidus
      UPSTREAM_DB_URL: mysql://root:noria@mysql/solidus
      ALLOWED_USERNAME: root
      ALLOWED_PASSWORD: noria
    links:
      - readyset-server
      - mysql
      - consul
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h127.0.0.1", "--port=3333", "-uroot", "-pnoria"]
      interval: 10s
      timeout: 10s
      retries: 2
      start_period: 5s
    depends_on:
      readyset-server:
        condition: service_healthy
  solidus:
    build: .
    ports:
      - 3000:3000
    links:
    - db
    - mysql
