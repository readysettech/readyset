steps:
  - label: ':docker: Build build image'
    key: build-image
    commands:
    - 'echo --- :docker: Building image'
    - >-
      docker build -f build/Dockerfile \
        --cache-from 069491470376.dkr.ecr.us-east-2.amazonaws.com/noria-mysql-build:latest \
        -t 069491470376.dkr.ecr.us-east-2.amazonaws.com/noria-mysql-build:latest \
        .
    - 'echo --- :docker: Pushing image'
    - 'docker push 069491470376.dkr.ecr.us-east-2.amazonaws.com/noria-mysql-build:latest'
    plugins:
      ecr#v2.2.0:
        login: true

  - label: ':rust: Check rustfmt'
    command: cargo fmt -- --check
    depends_on:
    - build-image
    plugins:
      - docker#v3.7.0:
          image: '069491470376.dkr.ecr.us-east-2.amazonaws.com/noria-mysql-build:latest'
          volumes:
          - 'target:/workdir/target'
          - './noria:/noria'
          - './msql-srv:/msql-srv'
          - './nom-sql:/nom-sql'
          environment:
          - SCCACHE_BUCKET=readyset-sccache
          - CARGO_INCREMENTAL=0
      - ecr#v2.2.0:
          login: true

  - label: ':rust: Build'
    key: build
    commands:
    - 'echo +++ :rust: Running cargo build'
    - cargo build --workspace
    depends_on:
    - build-image
    plugins:
      - docker#v3.7.0:
          image: '069491470376.dkr.ecr.us-east-2.amazonaws.com/noria-mysql-build:latest'
          volumes:
          - 'target:/workdir/target'
          - 'cargo-registry:/usr/local/cargo/registry'
          - './noria:/noria'
          - './msql-srv:/msql-srv'
          - './nom-sql:/nom-sql'
          environment:
          - SCCACHE_BUCKET=readyset-sccache
          - CARGO_INCREMENTAL=0
      - ecr#v2.2.0:
          login: true

  - label: ':rust: Test'
    command:
    - 'echo +++ :rust: Running cargo test'
    - cargo test -v --workspace
    depends_on:
    - build-image
    - build
    plugins:
      - docker-compose#v3.7.0:
          run: app
          env:
          - SCCACHE_BUCKET=readyset-sccache
          config: build/docker-compose.yaml
      - ecr#v2.2.0:
          login: true
    env:
      SCCACHE_BUCKET: readyset-sccache
