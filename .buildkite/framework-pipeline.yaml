steps:
  - label: ":docker: Build readyset-server image"
    key: readyset-server-image
    commands:
      - "echo --- :docker: Building readyset-server image"
      - >-
        docker build -f build/Dockerfile.readyset-server \
          --cache-from 305232526136.dkr.ecr.us-east-2.amazonaws.com/readyset-server:latest \
          -t 305232526136.dkr.ecr.us-east-2.amazonaws.com/readyset-server:latest \
          .
      - "echo --- :docker: Pushing image"
      - "docker push 305232526136.dkr.ecr.us-east-2.amazonaws.com/readyset-server:latest"
    plugins:
      ecr#v2.2.0:
        login: true
  - label: ":docker: Build readyset-mysql image"
    key: readyset-mysql-image
    commands:
      - "echo --- :docker: Building readyset-mysql image"
      - >-
        docker build -f build/Dockerfile.readyset-mysql \
          --cache-from 305232526136.dkr.ecr.us-east-2.amazonaws.com/readyset-mysql:latest \
          -t 305232526136.dkr.ecr.us-east-2.amazonaws.com/readyset-mysql:latest \
          .
      - "echo --- :docker: Pushing image"
      - "docker push 305232526136.dkr.ecr.us-east-2.amazonaws.com/readyset-mysql:latest"
    plugins:
      ecr#v2.2.0:
        login: true
  - key: list-frameworks
    label: "List frameworks"
    depends_on:
    - readyset-server-image
    - readyset-mysql-image
    plugins:
      - docker#v3.8.0:
          image: python:3
          command: ["./.buildkite/list-frameworks.sh"]
          mount-buildkite-agent: true
          mount-ssh-agent: true
          environment:
          - NIGHTLY=true
  - key: generate-pipeline
    label: "Generate test pipeline"
    depends_on:
    - list-frameworks
    plugins:
      - docker#v3.8.0:
          image: python:3
          command: ["./.buildkite/generate-framework-pipeline.py"]
          mount-buildkite-agent: true
          propagate-environment: true
    artifact_paths:
      - ".buildkite/gen/*"
