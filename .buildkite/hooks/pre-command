#!/usr/bin/env bash

if [ "$BUILDKITE_AGENT_META_DATA_QUEUE" = "apple" ]; then
  exit 0
fi

# Ensure that the `target` and `cargo-registry` volumes exist, so that steps
# that expect them to already exist (the ones that use docker-compose) can run
# even if they're the first steps to run on an agent
docker volume create target
docker volume create cargo-registry

# we create orchestrator-state as a tmp dir rather than a volume so that
# we can have the path match up between the host and the container, which
# allows the container to pass the correct paths to the -v flags set on
# other containers that are started by the installer during the smoke test:
mkdir /tmp/orchestrator-state

## Setup for framework testing
set -e
mkdir -pv .buildkite/gen .buildkite/image
buildkite-agent artifact download '.buildkite/gen/*' ./ || true
buildkite-agent artifact download '.buildkite/image/**/*.tar.gz' ./ || true
find .buildkite/image -type f | while read tarball; do
	docker load < "$tarball"
done
