# Buildkite pipeline for nightly (periodic) builds
steps:
  - label: ':docker: Build build image'
    key: build-image
    command: .buildkite/build_image.sh build/Dockerfile readyset-build
    plugins:
      ecr#v2.5.0:
        login: true
        retries: 3

  - label: 'Run MySQL generated logictests'
    key: logictest-generated-mysql
    command:
    - 'echo +++ Running noria-logictest'
    - LOG_LEVEL=error cargo run --bin noria-logictest --release -- verify logictests/generated/mysql -t 1 --database-type mysql
    depends_on:
    - build-image
    plugins:
      - docker-compose#v3.7.0:
          run: app
          env:
          - SCCACHE_BUCKET=readyset-sccache-e1
          - AWS_IAM_CREDENTIALS_URL=http://169.254.169.254/latest/meta-data/iam/security-credentials/buildkite-Role
          - CARGO_INCREMENTAL=0
          config:
            - docker-compose.yml
            - build/docker-compose.ci-test.yaml
          pull-retries: 3
      - ecr#v2.5.0:
          login: true
          retries: 3
    env:
      SCCACHE_BUCKET: readyset-sccache
    agents:
      queue: nightly

  - label: 'Run test flakiness check'
    key: flaky-finder
    command:
    - 'echo +++ Running flaky-finder'
    - flaky-finder -j1 -r5 --continue "cargo --locked test --all --exclude clustertest -- --nocapture --skip integration_serial"
    depends_on:
    - build-image
    plugins:
      - docker-compose#v3.7.0:
          run: app
          env:
          - SCCACHE_BUCKET=readyset-sccache-e1
          - AWS_IAM_CREDENTIALS_URL=http://169.254.169.254/latest/meta-data/iam/security-credentials/buildkite-Role
          - CARGO_INCREMENTAL=0
          config:
            - docker-compose.yml
            - build/docker-compose.ci-test.yaml
          pull-retries: 3
      - ecr#v2.2.0:
          login: true
    env:
      SCCACHE_BUCKET: readyset-sccache
    agents:
      queue: nightly

  - label: 'Run clustertests'
    key: noria-clustertest
    command:
    - 'echo +++ Building binaries for clustertest'
    - cargo --locked build --release --bin noria-server --bin noria-mysql
    - 'echo +++ Running Clustertests'
    - cargo --locked test clustertest
    timeout_in_minutes: 60

    depends_on:
    - build-image
    plugins:
      - docker-compose#v3.7.0:
          run: app
          env:
          - SCCACHE_BUCKET=readyset-sccache-e1
          - AWS_IAM_CREDENTIALS_URL=http://169.254.169.254/latest/meta-data/iam/security-credentials/buildkite-Role
          - CARGO_INCREMENTAL=0
          - BINARY_PATH=/workdir/target/release
          - MYSQL_ROOT_PASSWORD=noria
          volumes:
          - 'target:/workdir/target'
          config:
            - docker-compose.yml
            - build/docker-compose.ci-test.yaml
          mount-buildkite-agent: true
          pull-retries: 3
      - ecr#v2.2.0:
          login: true
    env:
      SCCACHE_BUCKET: readyset-sccache
    agents:
      queue: nightly
