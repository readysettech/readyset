steps:
  - label: ':bk-status-pending:'
    command: .buildkite/set_gerrit_running.sh
    agents:
      queue: t3a-small

  - wait: ~

  - label: ':git: Lint commits'
    key: lint-commits
    branches: '!refs/heads/main'
    commands:
    - ./scripts/commit_lint.sh
    agents:
      queue: t3a-small

  # Do not run pipeline if the lint has not passed
  - wait: ~

  - label: ":partyparrot: Creating the pipeline"
    agents:
      queue: t3a-small
    plugins:
      - Zegocover/git-diff-conditional#v1.1.1:
          log_level: DEBUG
          diff: "git diff --name-only HEAD HEAD~1"
          dynamic_pipeline: ".buildkite/pipeline.common.yml"
          steps:
            # Since we always want to be able to build a release binary, always build the build image.
            - label: ':docker: Build build image'

            # Since we always want to be able to build docker images, always build the base image.
            - label: ':docker: Build builder base image'

            - label: ':rust: Check rustfmt'
              include:
                - "[!ops]*"
                - Cargo.lock
                - Cargo.toml
                - rust-toolchain
                - ops/readyset-substrate

            - label: ':docker: Build cargo-deny image'
              include:
                - build/Dockerfile.cargo-deny
                - Cargo.lock
                - Cargo.toml
                - rust-toolchain

            - label: ':rust: :lock: Check cargo-deny'
              include:
                - build/Dockerfile.cargo-deny
                - Cargo.lock
                - Cargo.toml
                - rust-toolchain

            - label: ':clippy: Check clippy'
              include:
                - "[!ops]*"
                - Cargo.lock
                - Cargo.toml
                - rust-toolchain
                - ops/readyset-substrate

            - label: ":docker: Build readyset-server image"
              include:
                - "[!ops]*"
                - Cargo.lock
                - Cargo.toml
                - rust-toolchain

            - label: ':docker: Build readyset-mysql image'
              include:
                - "[!ops]*"
                - Cargo.lock
                - Cargo.toml
                - rust-toolchain

            - label: ':docker: Build readyset-psql image'
              include:
                - "[!ops]*"
                - Cargo.lock
                - Cargo.toml
                - rust-toolchain

            - label: ':docker: Build metrics-aggregator image'
              include:
                - "metrics-aggregator/**"

            - label: ':rust: Run tests'
              include:
                - "[!ops]*"
                - Cargo.lock
                - Cargo.toml
                - rust-toolchain
                - ops/readyset-substrate

            - label: 'Run logictest'
              include:
                - "[!ops]*"
                - Cargo.lock
                - Cargo.toml
                - rust-toolchain

            - label: 'Run logictest with MySQL replication'
              include:
                - "[!ops]*"
                - Cargo.lock
                - Cargo.toml
                - rust-toolchain

            - label: 'Run clustertests'
              include:
                - "[!ops]*"
                - Cargo.lock
                - Cargo.toml
                - rust-toolchain

            - label: ':rust: Deploy docs'
              include:
                - "[!ops]*"
                - Cargo.lock
                - Cargo.toml
                - rust-toolchain

            # --- START INTERNAL OPS STEPS --- #
            # Since we always want to be able to build images with packer, always build the ops image.
            - label: ':docker: Build readyset-ops image'

            - label: ':terraform: Format/Validate/Lint readyset module'
              include:
                - "ops/tf/**"

            - label: ':packer: Format/Validate images'
              include:
                - "ops/images/**"

            - label: ':shell::heavy_check_mark: shellcheck all scripts'
              include:
                - "ops/images/**"

            - label: ':packer: Run test build for all images'
              include:
                - "ops/images/**"

            - label: ":rust: :docker: Build Substrate Runtime Image"
              include:
                - "ops/readyset-substrate/**"
                - "ops/substrate/**"

            - label: ":rust: :terraform: Run validate on all Substrate root-modules"
              include:
                - "ops/readyset-substrate/**"
                - "ops/substrate/**"

            - label: ":rust: :terraform: Run plan on all Substrate root-modules"
              include:
                - "ops/readyset-substrate/**"
                - "ops/substrate/**"

            # --- END INTERNAL OPS STEPS --- #

            # --- START CLOUDFORMATION STEPS --- #
            - label: ':docker: Build readyset-ops-cfn image'
              include:
                - "ops/cfn/**"

            - label: ':aws-cloudformation: Lint with taskcat :cat:'
              include:
                - "ops/cfn/**"
            # --- END CLOUDFORMATIOn STEPS --- #

            # --- START JS CLIENT STEPS --- #
            - label: ':docker: Build prettier image'
              include:
                - "js-client/**"

            - label: ':prettier: Check prettier'
              include:
                - "js-client/**"

            - label: ":rust: Build js-client shared library"
              include:
                - "js-client/**"

            - label: ':nodejs: Test js-client'
              include:
                - "js-client/**"
            # --- END JS CLIENT STEPS --- #
            - label: 'List frameworks'
              include:
                - "readyset-framework-testing/**"

            - label: 'Generate framework pipeline'
              include:
                - "readyset-framework-testing/**"

            - label: 'Test readyset deployment'
              include:
                - "[!ops]*"
                - Cargo.lock
                - Cargo.toml
                - rust-toolchain

  - wait: ~
    continue_on_failure: true

  - command: ".buildkite/set_gerrit_status.sh"
    agents:
      queue: t3a-small

  - wait

  - trigger: "docker-release"
    branches: refs/heads/main
    label: ":rocket: Docker Release"
    build:
      branch: refs/heads/main
      commit: HEAD
      message: ":rocket: Docker Release for ${BUILDKITE_COMMIT}"
    async: true

  - trigger: "internal-amis"
    branches: refs/heads/main
    label: ":rocket: Internal AMIs"
    build:
      branch: refs/heads/main
      commit: ${BUILDKITE_COMMIT}
      message: ":rocket: Internal AMIs for ${BUILDKITE_COMMIT}"
    async: true

  - trigger: "external-amis"
    branches: refs/heads/main
    label: ":rocket: External AMIs"
    build:
      branch: refs/heads/main
      commit: ${BUILDKITE_COMMIT}
      message: ":rocket: External AMIs for ${BUILDKITE_COMMIT}"
    async: true

  - block: "Build :amazon-ec2: AMIs and :cloud: CFN templates"
    prompt: "Build AMIs and CFN templates?"

  - label: ':rust: Build readyset release binaries'
    key: build-binaries
    depends_on:
      - build-image
    commands:
      - 'echo +++ :rust: Running cargo build'
      - RUSTFLAGS='-D warnings' cargo build --release --bin noria-server --bin noria-mysql --bin noria-psql --bin ensure-ebs-volume --bin metrics-aggregator
      - strip target/release/noria-server target/release/noria-mysql target/release/noria-psql target/release/ensure-ebs-volume target/release/metrics-aggregator
    artifact_paths:
      - target/release/noria-server
      - target/release/noria-mysql
      - target/release/noria-psql
      - target/release/ensure-ebs-volume
      - target/release/metrics-aggregator
    plugins:
      - docker#v3.9.0:
          image: '305232526136.dkr.ecr.us-east-2.amazonaws.com/readyset-build:${BUILDKITE_COMMIT}'
          volumes:
            - 'cargo-registry:/usr/local/cargo/registry'
          environment:
            - CACHEPOT_BUCKET=readysettech-build-sccache-us-east-2
            - CACHEPOT_REGION=us-east-2
            - CARGO_INCREMENTAL=0
      - ecr#v2.5.0:
          login: true
          retries: 3

  - label: ":packer: Run build for internal images"
    key: packer-build
    depends_on:
    - build-binaries
    commands:
      - cd /workdir/ops/images
      - mkdir binaries
      - 'echo +++ :buildkite: Downloading binary artifacts'
      - buildkite-agent artifact download target/release/* binaries/
      - packer init .
      - 'echo +++ :packer: Running packer build'
      - packer build -only=amazon-ebs.readyset-* .
      - 'echo +++ :buildkite: Uploading manifest artifact'
      - buildkite-agent artifact upload packer-manifest.json
    plugins:
      - docker#v3.9.0:
          image: 305232526136.dkr.ecr.us-east-2.amazonaws.com/readyset-ops:${BUILDKITE_COMMIT}
          propagate-environment: true
          environment:
            - PACKER_CREATE_AMI=true
            - PACKER_PRODUCTION=true
      - ecr#v2.5.0:
          login: true
          retries: 3

  - label: ":python: :yaml: build CFN templates locally"
    key: packer-cfn-template-ytt
    depends_on:
    - packer-build
    commands:
      - buildkite-agent artifact download packer-manifest.json --step packer-build ./ops/image-deploy
      - cd ops/cfn/templates
      - ytt_apply.sh -i ../ytt_templates -m ../../image-deploy/packer-manifest.json -o ./
      - buildkite-agent artifact upload "./*.yaml"
    plugins:
      - docker#v3.9.0:
          image: 305232526136.dkr.ecr.us-east-2.amazonaws.com/readyset-ops:${BUILDKITE_COMMIT}
          propagate-environment: true
          propagate-aws-auth-tokens: true
      - ecr#v2.5.0:
          login: true
          retries: 3

  - label: ":rain_cloud: Lint CFN templates"
    key: packer-cfn-template-lint
    depends_on:
    - packer-cfn-template-ytt
    commands:
      - cd ops/cfn
      - mkdir ./rendered_templates
      - buildkite-agent artifact download "*.yaml" --step packer-cfn-template-ytt ./rendered_templates
      - rain fmt --verify rendered_templates/*
      - cfn-lint rendered_templates/*.yaml
    plugins:
      - docker#v3.9.0:
          image: 305232526136.dkr.ecr.us-east-2.amazonaws.com/readyset-ops:${BUILDKITE_COMMIT}
          propagate-environment: true
          propagate-aws-auth-tokens: true
      - ecr#v2.5.0:
          login: true
          retries: 3

  - label: ":aws: Copy CFN Templates to internal storage"
    key: packer-cfn-template-copy
    depends_on:
    - packer-cfn-template-lint
    commands:
      - cd ops/cfn
      - mkdir ./rendered_templates
      - buildkite-agent artifact download "*.yaml" --step packer-cfn-template-ytt ./rendered_templates
      - cd ./rendered_templates
      - aws s3 cp . s3://readysettech-cfn-internal-us-east-2/${BUILDKITE_COMMIT}/readyset/templates/ --exclude "*" --include "*.yaml" --recursive
    plugins:
      - docker#v3.9.0:
          image: 305232526136.dkr.ecr.us-east-2.amazonaws.com/readyset-ops:${BUILDKITE_COMMIT}
          propagate-environment: true
          propagate-aws-auth-tokens: true
      - ecr#v2.5.0:
          login: true
          retries: 3
      - cultureamp/aws-assume-role#v0.2.0
    env:
      AWS_ASSUME_ROLE_ARN: arn:aws:iam::888984949675:role/InternalArtifactsWrite
    agents:
      queue: ops
