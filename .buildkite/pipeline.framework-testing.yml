steps:
  - label: ":docker: Build readyset-server image"
    key: readyset-server-image
    command: .buildkite/build_image.sh build/Dockerfile.readyset-server readyset-server
    plugins:
      ecr#v2.5.0:
        login: true
        retries: 3
  - label: ":docker: Build readyset-mysql image"
    key: readyset-mysql-image
    command: .buildkite/build_image.sh build/Dockerfile.readyset-mysql readyset-mysql
    plugins:
      ecr#v2.5.0:
        login: true
        retries: 3
  - key: list-frameworks
    label: "List frameworks"
    depends_on:
    - readyset-server-image
    - readyset-mysql-image
    plugins:
      - docker#v3.8.0:
          image: 305232526136.dkr.ecr.us-east-2.amazonaws.com/mirror/python:3
          command: ["./.buildkite/list-frameworks.sh"]
          mount-buildkite-agent: true
          mount-ssh-agent: true
          environment:
          - NIGHTLY=true
      - ecr#v2.5.0:
          login: true
          retries: 3
  - key: generate-pipeline
    label: "Generate test pipeline"
    depends_on:
    - list-frameworks
    plugins:
      - docker#v3.8.0:
          image: 305232526136.dkr.ecr.us-east-2.amazonaws.com/mirror/python:3
          command: ["./.buildkite/generate-framework-pipeline.py"]
          mount-buildkite-agent: true
          propagate-environment: true
          environment:
          - NIGHTLY=true
      - ecr#v2.5.0:
          login: true
          retries: 3
    artifact_paths:
      - ".buildkite/gen/*"
