version: "3.8"
services:
  mysql:
    image: 305232526136.dkr.ecr.us-east-2.amazonaws.com/mirror/mysql:8.0
    expose:
      - 3306
    environment:
      MYSQL_DATABASE: test
      MYSQL_ROOT_PASSWORD: root
    healthcheck:
      test: "mysqladmin ping"
      start_period: 10s
      interval: 10s
      timeout: 2s
      retries: 5
  db:
    image: "305232526136.dkr.ecr.us-east-2.amazonaws.com/readyset-mysql:${BUILDKITE_COMMIT}"
    expose:
      - 3333
    environment:
      UPSTREAM_DB_URL: mysql://root:root@mysql/test
      NORIA_DEPLOYMENT: frameworktests
      STANDALONE: 1
      LISTEN_ADDRESS: 0.0.0.0:3333
      ALLOWED_USERNAME: root
      ALLOWED_PASSWORD: root
      EXPLICIT_MIGRATIONS: 1
      UNSUPPORTED_SET_MODE: proxy
    volumes:
      - "readyset-server-state:/state"
    links:
      - mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h127.0.0.1", "--port=3333", "-uroot", "-proot"]
      interval: 10s
      timeout: 10s
      retries: 2
      start_period: 5s
    depends_on:
      mysql:
        condition: service_healthy
volumes:
  readyset-server-state: ~
