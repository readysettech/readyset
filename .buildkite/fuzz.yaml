# Buildkite pipeline for fuzz-testing
steps:
  - label: ':docker: Build build image'
    key: build-image
    commands:
    - 'echo --- :docker: Building image'
    - >-
      docker build -f build/Dockerfile \
        --cache-from 069491470376.dkr.ecr.us-east-2.amazonaws.com/noria-build:latest \
        -t 069491470376.dkr.ecr.us-east-2.amazonaws.com/noria-build:latest \
        .
    - 'echo --- :docker: Pushing image'
    - 'docker push 069491470376.dkr.ecr.us-east-2.amazonaws.com/noria-build:latest'
    plugins:
      ecr#v2.2.0:
        login: true

  - label: 'Run fuzz tests'
    key: logictest-fuzz
    command:
    - 'echo +++ Running noria-logictest'
    - cargo run --bin noria-logictest -- fuzz -n 5000 --compare-to mysql://root:noria@mysql/noria
    timeout_in_minutes: 360
    depends_on:
    - build-image
    plugins:
      - docker-compose#v3.7.0:
          run: app
          env:
          - SCCACHE_BUCKET=readyset-sccache-e1
          - AWS_IAM_CREDENTIALS_URL=http://169.254.169.254/latest/meta-data/iam/security-credentials/buildkite-Role
          - CARGO_INCREMENTAL=0
          config:
            - docker-compose.yml
            - build/docker-compose.ci-test.yaml
      - ecr#v2.2.0:
          login: true
    env:
      SCCACHE_BUCKET: readyset-sccache
      PROPTEST_MAX_SHRINK_ITERS: 1000
